<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Vue源码过程," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="补充事件改一下例子 main.js 12345678910111213141516171819202122232425262728import Vue from &apos;vue&apos;import App from &apos;./App&apos;;Vue.config.productionTip = false/* eslint-disable no-new */new Vue(&amp;#123;  el: &apos;#app&apos;,  da">
<meta name="keywords" content="Vue源码过程">
<meta property="og:type" content="article">
<meta property="og:title" content="Vue源码过程（7）- 补充">
<meta property="og:url" content="http://yoursite.com/2019/09/08/Vue源码解析（7）-补充/index.html">
<meta property="og:site_name" content="渣渣大星星的学习笔记">
<meta property="og:description" content="补充事件改一下例子 main.js 12345678910111213141516171819202122232425262728import Vue from &apos;vue&apos;import App from &apos;./App&apos;;Vue.config.productionTip = false/* eslint-disable no-new */new Vue(&amp;#123;  el: &apos;#app&apos;,  da">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://114.55.30.96/WX20190906-230735@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190906-232213@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190907-125550@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190907-125619@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190907-133025@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190907-133856@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190907-145809@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190907-151133@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190907-151217@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190907-151354@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190907-151541@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190907-165247@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190907-165937@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190907-170314@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190907-171130@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190907-222530@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190907-222753@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190906-151714@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190906-151816@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190906-152105@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190906-161250@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190906-161533@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190906-165558@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190906-171617@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190906-174914@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190906-172113@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190906-175418@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190906-180033@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190906-185324@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190906-185653@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190906-185841@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190906-190059@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190907-123004@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190908-233124@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190908-233206@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190908-234713@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190908-234921@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190908-235121@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190908-235121@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190909-082624@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190909-084215@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190909-002952@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190909-084428@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190909-084607@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190909-101749@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190909-102602@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190909-103118@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190909-103558@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190909-104124@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190909-125426@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190909-125530@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190909-130108@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190909-130256@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190909-221338@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190909-222713@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190909-225609@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190909-224918@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190909-224041@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190909-225316@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190909-225405@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190910-210255@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190910-204120@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190910-205350@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20190910-212407@2x.png">
<meta property="og:image" content="http://114.55.30.96/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190927223928.png">
<meta property="og:image" content="http://114.55.30.96/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190928191902.png">
<meta property="og:image" content="http://114.55.30.96/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190928101915.png">
<meta property="og:image" content="http://114.55.30.96/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190928185150.png">
<meta property="og:image" content="http://114.55.30.96/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190928192812.png">
<meta property="og:image" content="http://114.55.30.96/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190928193001.png">
<meta property="og:image" content="http://114.55.30.96/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190929010011.png">
<meta property="og:image" content="http://114.55.30.96/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190929235816.png">
<meta property="og:image" content="http://114.55.30.96/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190930000934.png">
<meta property="og:image" content="http://114.55.30.96/WX20191007-130322@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20191007-130349@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20191007-130403@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20191007-130428@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20191024-000600@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20191024-000626@2x.png">
<meta property="og:image" content="http://114.55.30.96/WX20191024-000744@2x.png">
<meta property="og:updated_time" content="2020-02-10T13:01:14.296Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Vue源码过程（7）- 补充">
<meta name="twitter:description" content="补充事件改一下例子 main.js 12345678910111213141516171819202122232425262728import Vue from &apos;vue&apos;import App from &apos;./App&apos;;Vue.config.productionTip = false/* eslint-disable no-new */new Vue(&amp;#123;  el: &apos;#app&apos;,  da">
<meta name="twitter:image" content="http://114.55.30.96/WX20190906-230735@2x.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/09/08/Vue源码解析（7）-补充/"/>





  <title>Vue源码过程（7）- 补充 | 渣渣大星星的学习笔记</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">渣渣大星星的学习笔记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/index.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/index.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/index.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/08/Vue源码解析（7）-补充/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="秦瀚文">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="渣渣大星星的学习笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Vue源码过程（7）- 补充</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-09-08T14:23:31+08:00">
                2019-09-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Vue源码过程/" itemprop="url" rel="index">
                    <span itemprop="name">Vue源码过程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><h3 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h3><p>改一下例子</p>
<p>main.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App'</span>;</span><br><span class="line">Vue.config.productionTip = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* eslint-disable no-new */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  data: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      message: <span class="string">"123"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  components: &#123;</span><br><span class="line">    App</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    clickHandler() &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Child clicked!'</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    selectHandler() &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Child select!'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  template: <span class="string">`&lt;div&gt; </span></span><br><span class="line"><span class="string">  &lt;App @select="selectHandler" @click.native.prevent="clickHandler" /&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;`</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>App.vue</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;button @click=&quot;clickHandler($event)&quot;&gt;click me&lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;App&quot;,</span><br><span class="line">  props: &#123;</span><br><span class="line">    firstName: String</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    clickHandler(e) &#123;</span><br><span class="line">      console.log(&quot;Button clicked!&quot;, e);</span><br><span class="line">      this.$emit(&quot;select&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>从<code>var code = ast ? genElement(ast, state) : &#39;_c(&quot;div&quot;)&#39;;</code>开始，先看生成的<code>ast</code>，进入<code>genElement</code>方法</p>
<p><img src="http://114.55.30.96/WX20190906-230735@2x.png" alt="WX20190906-230735@2x"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generate</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  ast,</span></span></span><br><span class="line"><span class="function"><span class="params">  options</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> state = <span class="keyword">new</span> CodegenState(options);</span><br><span class="line">  <span class="keyword">var</span> code = ast ? genElement(ast, state) : <span class="string">'_c("div")'</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    render: (<span class="string">"with(this)&#123;return "</span> + code + <span class="string">"&#125;"</span>),</span><br><span class="line">    staticRenderFns: state.staticRenderFns</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入<code>genElement</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genElement</span> (<span class="params">el, state</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (el.parent) &#123;</span><br><span class="line">    el.pre = el.pre || el.parent.pre;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (el.staticRoot &amp;&amp; !el.staticProcessed) &#123;</span><br><span class="line">    <span class="keyword">return</span> genStatic(el, state)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.once &amp;&amp; !el.onceProcessed) &#123;</span><br><span class="line">    <span class="keyword">return</span> genOnce(el, state)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.for &amp;&amp; !el.forProcessed) &#123;</span><br><span class="line">    <span class="keyword">return</span> genFor(el, state)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.if &amp;&amp; !el.ifProcessed) &#123;</span><br><span class="line">    <span class="keyword">return</span> genIf(el, state)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.tag === <span class="string">'template'</span> &amp;&amp; !el.slotTarget &amp;&amp; !state.pre) &#123;</span><br><span class="line">    <span class="keyword">return</span> genChildren(el, state) || <span class="string">'void 0'</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.tag === <span class="string">'slot'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> genSlot(el, state)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// component or element</span></span><br><span class="line">    <span class="keyword">var</span> code;</span><br><span class="line">    <span class="keyword">if</span> (el.component) &#123;</span><br><span class="line">      code = genComponent(el.component, el, state);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">var</span> data;</span><br><span class="line">      <span class="keyword">if</span> (!el.plain || (el.pre &amp;&amp; state.maybeComponent(el))) &#123;</span><br><span class="line">        data = genData$<span class="number">2</span>(el, state);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">var</span> children = el.inlineTemplate ? <span class="literal">null</span> : genChildren(el, state, <span class="literal">true</span>);</span><br><span class="line">      code = <span class="string">"_c('"</span> + (el.tag) + <span class="string">"'"</span> + (data ? (<span class="string">","</span> + data) : <span class="string">''</span>) + (children ? (<span class="string">","</span> + children) : <span class="string">''</span>) + <span class="string">")"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// module transforms</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; state.transforms.length; i++) &#123;</span><br><span class="line">      code = state.transforms[i](el, code);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> code</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入<code>genChildren</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genChildren</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  el,</span></span></span><br><span class="line"><span class="function"><span class="params">  state,</span></span></span><br><span class="line"><span class="function"><span class="params">  checkSkip,</span></span></span><br><span class="line"><span class="function"><span class="params">  altGenElement,</span></span></span><br><span class="line"><span class="function"><span class="params">  altGenNode</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> children = el.children;</span><br><span class="line">  <span class="keyword">if</span> (children.length) &#123;</span><br><span class="line">    <span class="keyword">var</span> el$<span class="number">1</span> = children[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">// optimize single v-for</span></span><br><span class="line">    <span class="keyword">if</span> (children.length === <span class="number">1</span> &amp;&amp;</span><br><span class="line">      el$<span class="number">1.</span><span class="keyword">for</span> &amp;&amp;</span><br><span class="line">      el$<span class="number">1.</span>tag !== <span class="string">'template'</span> &amp;&amp;</span><br><span class="line">      el$<span class="number">1.</span>tag !== <span class="string">'slot'</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">var</span> normalizationType = checkSkip</span><br><span class="line">        ? state.maybeComponent(el$<span class="number">1</span>) ? <span class="string">",1"</span> : <span class="string">",0"</span></span><br><span class="line">        : <span class="string">""</span>;</span><br><span class="line">      <span class="keyword">return</span> (<span class="string">""</span> + ((altGenElement || genElement)(el$<span class="number">1</span>, state)) + normalizationType)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> normalizationType$<span class="number">1</span> = checkSkip</span><br><span class="line">      ? getNormalizationType(children, state.maybeComponent)</span><br><span class="line">      : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> gen = altGenNode || genNode;</span><br><span class="line">    <span class="keyword">return</span> (<span class="string">"["</span> + (children.map(<span class="function"><span class="keyword">function</span> (<span class="params">c</span>) </span>&#123; <span class="keyword">return</span> gen(c, state); &#125;).join(<span class="string">','</span>)) + <span class="string">"]"</span> + (normalizationType$<span class="number">1</span> ? (<span class="string">","</span> + normalizationType$<span class="number">1</span>) : <span class="string">''</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里遍历子节点数组，进入<code>gen</code>方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genNode</span> (<span class="params">node, state</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (node.type === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> genElement(node, state)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.type === <span class="number">3</span> &amp;&amp; node.isComment) &#123;</span><br><span class="line">    <span class="keyword">return</span> genComment(node)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> genText(node)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>又进到<code>genElement</code></p>
<p><img src="http://114.55.30.96/WX20190906-232213@2x.png" alt="WX20190906-232213@2x"></p>
<p>这次走到了<code>genData$2</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genData$2</span> (<span class="params">el, state</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> data = <span class="string">'&#123;'</span>;</span><br><span class="line">  <span class="keyword">var</span> dirs = genDirectives(el, state);</span><br><span class="line">  <span class="keyword">if</span> (dirs) &#123; data += dirs + <span class="string">','</span>; &#125;</span><br><span class="line">  <span class="keyword">if</span> (el.key) &#123;</span><br><span class="line">    data += <span class="string">"key:"</span> + (el.key) + <span class="string">","</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (el.ref) &#123;</span><br><span class="line">    data += <span class="string">"ref:"</span> + (el.ref) + <span class="string">","</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (el.refInFor) &#123;</span><br><span class="line">    data += <span class="string">"refInFor:true,"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (el.pre) &#123;</span><br><span class="line">    data += <span class="string">"pre:true,"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (el.component) &#123;</span><br><span class="line">    data += <span class="string">"tag:\""</span> + (el.tag) + <span class="string">"\","</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; state.dataGenFns.length; i++) &#123;</span><br><span class="line">    data += state.dataGenFns[i](el);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (el.attrs) &#123;</span><br><span class="line">    data += <span class="string">"attrs:"</span> + (genProps(el.attrs)) + <span class="string">","</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (el.props) &#123;</span><br><span class="line">    data += <span class="string">"domProps:"</span> + (genProps(el.props)) + <span class="string">","</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (el.events) &#123;</span><br><span class="line">    data += (genHandlers(el.events, <span class="literal">false</span>)) + <span class="string">","</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (el.nativeEvents) &#123;</span><br><span class="line">    data += (genHandlers(el.nativeEvents, <span class="literal">true</span>)) + <span class="string">","</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (el.slotTarget &amp;&amp; !el.slotScope) &#123;</span><br><span class="line">    data += <span class="string">"slot:"</span> + (el.slotTarget) + <span class="string">","</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (el.scopedSlots) &#123;</span><br><span class="line">    data += (genScopedSlots(el, el.scopedSlots, state)) + <span class="string">","</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (el.model) &#123;</span><br><span class="line">    data += <span class="string">"model:&#123;value:"</span> + (el.model.value) + <span class="string">",callback:"</span> + (el.model.callback) + <span class="string">",expression:"</span> + (el.model.expression) + <span class="string">"&#125;,"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (el.inlineTemplate) &#123;</span><br><span class="line">    <span class="keyword">var</span> inlineTemplate = genInlineTemplate(el, state);</span><br><span class="line">    <span class="keyword">if</span> (inlineTemplate) &#123;</span><br><span class="line">      data += inlineTemplate + <span class="string">","</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  data = data.replace(<span class="regexp">/,$/</span>, <span class="string">''</span>) + <span class="string">'&#125;'</span>;</span><br><span class="line">  <span class="keyword">if</span> (el.dynamicAttrs) &#123;</span><br><span class="line">    data = <span class="string">"_b("</span> + data + <span class="string">",\""</span> + (el.tag) + <span class="string">"\","</span> + (genProps(el.dynamicAttrs)) + <span class="string">")"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (el.wrapData) &#123;</span><br><span class="line">    data = el.wrapData(data);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (el.wrapListeners) &#123;</span><br><span class="line">    data = el.wrapListeners(data);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1）声明<code>data</code>初始值为<code>{</code></p>
<p>2）这两个逻辑中，为<code>data</code>拼接事件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (el.events) &#123;</span><br><span class="line">  data += (genHandlers(el.events, <span class="literal">false</span>)) + <span class="string">","</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (el.nativeEvents) &#123;</span><br><span class="line">  data += (genHandlers(el.nativeEvents, <span class="literal">true</span>)) + <span class="string">","</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"&#123;on:&#123;"</span>select<span class="string">":selectHandler&#125;,nativeOn:&#123;"</span>click<span class="string">":function($event)&#123;return clickHandler($event)&#125;&#125;,"</span></span><br></pre></td></tr></table></figure>
<p>3）最后去掉尾巴的逗号</p>
<p>所以最后得到的<code>render</code>方法是这样的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"with(this)&#123;return _c('div',[_c('App',&#123;on:&#123;"</span>select<span class="string">":selectHandler&#125;,nativeOn:&#123;"</span>click<span class="string">":function($event)&#123;return clickHandler($event)&#125;&#125;&#125;)],1)&#125;"</span></span><br></pre></td></tr></table></figure>
<p>看一下生成<code>vnode</code>调用<code>render</code>方法的时候，发现<code>App</code>是个<code>component</code>，不是普通的HTML标签，所以创建组件<code>vnode</code>，下面是创建组件<code>vnode</code>的过程：</p>
<p><img src="http://114.55.30.96/WX20190907-125550@2x.png" alt="WX20190907-125550@2x"></p>
<p><img src="http://114.55.30.96/WX20190907-125619@2x.png" alt="WX20190907-125619@2x"></p>
<p>变量<code>lsteners</code>保存了<code>data.on</code>，并将<code>data.on</code>指向<code>data.nativeOn</code>，然后为组件安装声明周期钩子函数</p>
<p><img src="http://114.55.30.96/WX20190907-133025@2x.png" alt="WX20190907-133025@2x"></p>
<p>之后创建组件<code>vnode</code>，这就是生成的组件<code>vnode</code></p>
<p><img src="http://114.55.30.96/WX20190907-133856@2x.png" alt="WX20190907-133856@2x"></p>
<p>进入<code>update</code>方法，首先是创建<code>div</code>占位符，然后遍历<code>children</code>，创建子节点，就看一下创建组件<code>App</code>的过程，在<code>createComponent</code>的时候，会调用子组件的<code>init</code>钩子方法</p>
<p><img src="http://114.55.30.96/WX20190907-145809@2x.png" alt="WX20190907-145809@2x"></p>
<p>最后调用<code>child.$mount</code>挂载子组件，在挂载子组件过程中，会先生成子组件<code>vnode</code>，之后再挂载。</p>
<p>挂载之前会为元素添加事件了</p>
<p><img src="http://114.55.30.96/WX20190907-151133@2x.png" alt="WX20190907-151133@2x"></p>
<p>进入<code>invokeCreateHooks</code>方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">invokeCreateHooks</span> (<span class="params">vnode, insertedVnodeQueue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i$<span class="number">1</span> = <span class="number">0</span>; i$<span class="number">1</span> &lt; cbs.create.length; ++i$<span class="number">1</span>) &#123;</span><br><span class="line">    cbs.create[i$<span class="number">1</span>](emptyNode, vnode);</span><br><span class="line">  &#125;</span><br><span class="line">  i = vnode.data.hook; <span class="comment">// Reuse variable</span></span><br><span class="line">  <span class="keyword">if</span> (isDef(i)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDef(i.create)) &#123; i.create(emptyNode, vnode); &#125;</span><br><span class="line">    <span class="keyword">if</span> (isDef(i.insert)) &#123; insertedVnodeQueue.push(vnode); &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://114.55.30.96/WX20190907-151217@2x.png" alt="WX20190907-151217@2x"></p>
<p>进入<code>updateDOMListeners</code>方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateDOMListeners</span> (<span class="params">oldVnode, vnode</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isUndef(oldVnode.data.on) &amp;&amp; isUndef(vnode.data.on)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> on = vnode.data.on || &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> oldOn = oldVnode.data.on || &#123;&#125;;</span><br><span class="line">  target$<span class="number">1</span> = vnode.elm;</span><br><span class="line">  normalizeEvents(on);</span><br><span class="line">  updateListeners(on, oldOn, add$<span class="number">1</span>, remove$<span class="number">2</span>, createOnceHandler$<span class="number">1</span>, vnode.context);</span><br><span class="line">  target$<span class="number">1</span> = <span class="literal">undefined</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://114.55.30.96/WX20190907-151354@2x.png" alt="WX20190907-151354@2x"></p>
<p>进入<code>updateListeners</code>方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateListeners</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  on,</span></span></span><br><span class="line"><span class="function"><span class="params">  oldOn,</span></span></span><br><span class="line"><span class="function"><span class="params">  add,</span></span></span><br><span class="line"><span class="function"><span class="params">  remove$$<span class="number">1</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  createOnceHandler,</span></span></span><br><span class="line"><span class="function"><span class="params">  vm</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> name, def$$<span class="number">1</span>, cur, old, event;</span><br><span class="line">  <span class="keyword">for</span> (name <span class="keyword">in</span> on) &#123;</span><br><span class="line">    def$$<span class="number">1</span> = cur = on[name];</span><br><span class="line">    old = oldOn[name];</span><br><span class="line">    event = normalizeEvent(name);</span><br><span class="line">    <span class="keyword">if</span> (isUndef(cur)) &#123;</span><br><span class="line">      process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; warn(</span><br><span class="line">        <span class="string">"Invalid handler for event \""</span> + (event.name) + <span class="string">"\": got "</span> + <span class="built_in">String</span>(cur),</span><br><span class="line">        vm</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isUndef(old)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isUndef(cur.fns)) &#123;</span><br><span class="line">        cur = on[name] = createFnInvoker(cur, vm);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (isTrue(event.once)) &#123;</span><br><span class="line">        cur = on[name] = createOnceHandler(event.name, cur, event.capture);</span><br><span class="line">      &#125;</span><br><span class="line">      add(event.name, cur, event.capture, event.passive, event.params);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cur !== old) &#123;</span><br><span class="line">      old.fns = cur;</span><br><span class="line">      on[name] = old;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (name <span class="keyword">in</span> oldOn) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isUndef(on[name])) &#123;</span><br><span class="line">      event = normalizeEvent(name);</span><br><span class="line">      remove$$<span class="number">1</span>(event.name, oldOn[name], event.capture);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://114.55.30.96/WX20190907-151541@2x.png" alt="WX20190907-151541@2x"></p>
<p>进入<code>add</code>方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add$1</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  name,</span></span></span><br><span class="line"><span class="function"><span class="params">  handler,</span></span></span><br><span class="line"><span class="function"><span class="params">  capture,</span></span></span><br><span class="line"><span class="function"><span class="params">  passive</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// async edge case #6566: inner click event triggers patch, event handler</span></span><br><span class="line">  <span class="comment">// attached to outer element during patch, and triggered again. This</span></span><br><span class="line">  <span class="comment">// happens because browsers fire microtask ticks between event propagation.</span></span><br><span class="line">  <span class="comment">// the solution is simple: we save the timestamp when a handler is attached,</span></span><br><span class="line">  <span class="comment">// and the handler would only fire if the event passed to it was fired</span></span><br><span class="line">  <span class="comment">// AFTER it was attached.</span></span><br><span class="line">  <span class="keyword">if</span> (useMicrotaskFix) &#123;</span><br><span class="line">    <span class="keyword">var</span> attachedTimestamp = currentFlushTimestamp;</span><br><span class="line">    <span class="keyword">var</span> original = handler;</span><br><span class="line">    handler = original._wrapper = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        <span class="comment">// no bubbling, should always fire.</span></span><br><span class="line">        <span class="comment">// this is just a safety net in case event.timeStamp is unreliable in</span></span><br><span class="line">        <span class="comment">// certain weird environments...</span></span><br><span class="line">        e.target === e.currentTarget ||</span><br><span class="line">        <span class="comment">// event is fired after handler attachment</span></span><br><span class="line">        e.timeStamp &gt;= attachedTimestamp ||</span><br><span class="line">        <span class="comment">// bail for environments that have buggy event.timeStamp implementations</span></span><br><span class="line">        <span class="comment">// #9462 iOS 9 bug: event.timeStamp is 0 after history.pushState</span></span><br><span class="line">        <span class="comment">// #9681 QtWebEngine event.timeStamp is negative value</span></span><br><span class="line">        e.timeStamp &lt;= <span class="number">0</span> ||</span><br><span class="line">        <span class="comment">// #9448 bail if event is fired in another document in a multi-page</span></span><br><span class="line">        <span class="comment">// electron/nw.js app, since event.timeStamp will be using a different</span></span><br><span class="line">        <span class="comment">// starting reference</span></span><br><span class="line">        e.target.ownerDocument !== <span class="built_in">document</span></span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="keyword">return</span> original.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  target$<span class="number">1.</span>addEventListener(</span><br><span class="line">    name,</span><br><span class="line">    handler,</span><br><span class="line">    supportsPassive</span><br><span class="line">      ? &#123; <span class="attr">capture</span>: capture, <span class="attr">passive</span>: passive &#125;</span><br><span class="line">      : capture</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里为元素添加事件</p>
<p>点击一下触发点击事件</p>
<p><img src="http://114.55.30.96/WX20190907-165247@2x.png" alt="WX20190907-165247@2x"></p>
<p>走进<code>original.apply(this,arguments)</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">invoker</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> <span class="built_in">arguments</span>$<span class="number">1</span> = <span class="built_in">arguments</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> fns = invoker.fns;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(fns)) &#123;</span><br><span class="line">    <span class="keyword">var</span> cloned = fns.slice();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; cloned.length; i++) &#123;</span><br><span class="line">      invokeWithErrorHandling(cloned[i], <span class="literal">null</span>, <span class="built_in">arguments</span>$<span class="number">1</span>, vm, <span class="string">"v-on handler"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// return handler return value for single handlers</span></span><br><span class="line">    <span class="keyword">return</span> invokeWithErrorHandling(fns, <span class="literal">null</span>, <span class="built_in">arguments</span>, vm, <span class="string">"v-on handler"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>走进<code>invokeWithErrorHandling(fns, null, arguments, vm, &quot;v-on handler&quot;)</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">invokeWithErrorHandling</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  handler,</span></span></span><br><span class="line"><span class="function"><span class="params">  context,</span></span></span><br><span class="line"><span class="function"><span class="params">  args,</span></span></span><br><span class="line"><span class="function"><span class="params">  vm,</span></span></span><br><span class="line"><span class="function"><span class="params">  info</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> res;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    res = args ? handler.apply(context, args) : handler.call(context);</span><br><span class="line">    <span class="keyword">if</span> (res &amp;&amp; !res._isVue &amp;&amp; isPromise(res) &amp;&amp; !res._handled) &#123;</span><br><span class="line">      res.catch(<span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123; <span class="keyword">return</span> handleError(e, vm, info + <span class="string">" (Promise/async)"</span>); &#125;);</span><br><span class="line">      <span class="comment">// issue #9511</span></span><br><span class="line">      <span class="comment">// avoid catch triggering multiple times when nested calls</span></span><br><span class="line">      res._handled = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    handleError(e, vm, info);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>走进<code>handler.apply(context, args)</code></p>
<p><img src="http://114.55.30.96/WX20190907-165937@2x.png" alt="WX20190907-165937@2x"></p>
<p>触发<code>App</code>组件的<code>click</code>事件，不过触发之前，先回从<code>_vm</code>上取<code>clickHandler</code>，所以走到了<code>get</code></p>
<p><img src="http://114.55.30.96/WX20190907-170314@2x.png" alt="WX20190907-170314@2x"></p>
<p>这里补充一下<code>initMethods</code>方法吧，在初始化调用<code>initState</code>的时候会走进<code>initMethods</code>方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initMethods</span> (<span class="params">vm, methods</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> props = vm.$options.props;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> methods) &#123;</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> methods[key] !== <span class="string">'function'</span>) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          <span class="string">"Method \""</span> + key + <span class="string">"\" has type \""</span> + (<span class="keyword">typeof</span> methods[key]) + <span class="string">"\" in the component definition. "</span> +</span><br><span class="line">          <span class="string">"Did you reference the function correctly?"</span>,</span><br><span class="line">          vm</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (props &amp;&amp; hasOwn(props, key)) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          (<span class="string">"Method \""</span> + key + <span class="string">"\" has already been defined as a prop."</span>),</span><br><span class="line">          vm</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ((key <span class="keyword">in</span> vm) &amp;&amp; isReserved(key)) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          <span class="string">"Method \""</span> + key + <span class="string">"\" conflicts with an existing Vue instance method. "</span> +</span><br><span class="line">          <span class="string">"Avoid defining component methods that start with _ or $."</span></span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    vm[key] = <span class="keyword">typeof</span> methods[key] !== <span class="string">'function'</span> ? noop : bind(methods[key], vm);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法，其实就是在<code>vm</code>上添加属性方法（<code>bind(methods[key],vm)</code>返回是个绑定了<code>this</code>方法）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">nativeBind</span> (<span class="params">fn, ctx</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> fn.bind(ctx)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续说触发了<code>App</code>组件<code>click</code>方法</p>
<p><img src="http://114.55.30.96/WX20190907-171130@2x.png" alt="WX20190907-171130@2x"></p>
<p>先打印出<code>Button clicked,xxxxxx</code>，之后调用<code>this.$emit</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype.$emit = <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> vm = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> lowerCaseEvent = event.toLowerCase();</span><br><span class="line">    <span class="keyword">if</span> (lowerCaseEvent !== event &amp;&amp; vm._events[lowerCaseEvent]) &#123;</span><br><span class="line">      tip(</span><br><span class="line">        <span class="string">"Event \""</span> + lowerCaseEvent + <span class="string">"\" is emitted in component "</span> +</span><br><span class="line">        (formatComponentName(vm)) + <span class="string">" but the handler is registered for \""</span> + event + <span class="string">"\". "</span> +</span><br><span class="line">        <span class="string">"Note that HTML attributes are case-insensitive and you cannot use "</span> +</span><br><span class="line">        <span class="string">"v-on to listen to camelCase events when using in-DOM templates. "</span> +</span><br><span class="line">        <span class="string">"You should probably use \""</span> + (hyphenate(event)) + <span class="string">"\" instead of \""</span> + event + <span class="string">"\"."</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> cbs = vm._events[event];</span><br><span class="line">  <span class="keyword">if</span> (cbs) &#123;</span><br><span class="line">    cbs = cbs.length &gt; <span class="number">1</span> ? toArray(cbs) : cbs;</span><br><span class="line">    <span class="keyword">var</span> args = toArray(<span class="built_in">arguments</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">var</span> info = <span class="string">"event handler for \""</span> + event + <span class="string">"\""</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = cbs.length; i &lt; l; i++) &#123;</span><br><span class="line">      invokeWithErrorHandling(cbs[i], vm, args, vm, info);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> vm</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>获取<code>vm._events[event]</code>，然后遍历它，调用每一项的方法，那么<code>vm._events</code>在什么时候加的呢？在<code>initEvents(vm);</code>的时候</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initEvents</span> (<span class="params">vm</span>) </span>&#123;</span><br><span class="line">  vm._events = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line">  vm._hasHookEvent = <span class="literal">false</span>;</span><br><span class="line">  <span class="comment">// init parent attached events</span></span><br><span class="line">  <span class="keyword">var</span> listeners = vm.$options._parentListeners;</span><br><span class="line">  <span class="keyword">if</span> (listeners) &#123;</span><br><span class="line">    updateComponentListeners(vm, listeners);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着就是调用<code>selectHandler</code>方法</p>
<p><img src="http://114.55.30.96/WX20190907-222530@2x.png" alt="WX20190907-222530@2x"></p>
<p>然后冒泡，触发</p>
<p><img src="http://114.55.30.96/WX20190907-222753@2x.png" alt="WX20190907-222753@2x"></p>
<h3 id="双向绑定原理"><a href="#双向绑定原理" class="headerlink" title="双向绑定原理"></a><strong>双向绑定原理</strong></h3><p>改一下例子</p>
<p>main.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line">Vue.config.productionTip = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* eslint-disable no-new */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  data: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      message:<span class="string">"123"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line">  template: <span class="string">`&lt;div&gt;</span></span><br><span class="line"><span class="string">    &lt;input v-model="message" /&gt;</span></span><br><span class="line"><span class="string">    &#123;&#123;message&#125;&#125;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;`</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>从<code>var code = generate(ast, options);</code>开始</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> createCompiler = createCompilerCreator(<span class="function"><span class="keyword">function</span> <span class="title">baseCompile</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  template,</span></span></span><br><span class="line"><span class="function"><span class="params">  options</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> ast = parse(template.trim(), options);</span><br><span class="line">  <span class="keyword">if</span> (options.optimize !== <span class="literal">false</span>) &#123;</span><br><span class="line">    optimize(ast, options);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> code = generate(ast, options);</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ast: ast,</span><br><span class="line">    render: code.render,</span><br><span class="line">    staticRenderFns: code.staticRenderFns</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>一直往下走，这是调用栈</p>
<p><img src="http://114.55.30.96/WX20190906-151714@2x.png" alt="WX20190906-151714@2x"></p>
<p>当<code>el</code>是<code>input</code>的时候</p>
<p><img src="http://114.55.30.96/WX20190906-151816@2x.png" alt="WX20190906-151816@2x"></p>
<p>走进<code>genData$2</code></p>
<p><img src="http://114.55.30.96/WX20190906-152105@2x.png" alt="WX20190906-152105@2x"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genData$2</span> (<span class="params">el, state</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> data = <span class="string">'&#123;'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// directives first.</span></span><br><span class="line">  <span class="comment">// directives may mutate the el's other properties before they are generated.</span></span><br><span class="line">  <span class="keyword">var</span> dirs = genDirectives(el, state);</span><br><span class="line">  <span class="keyword">if</span> (dirs) &#123; data += dirs + <span class="string">','</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// key</span></span><br><span class="line">  <span class="keyword">if</span> (el.key) &#123;</span><br><span class="line">    data += <span class="string">"key:"</span> + (el.key) + <span class="string">","</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ref</span></span><br><span class="line">  <span class="keyword">if</span> (el.ref) &#123;</span><br><span class="line">    data += <span class="string">"ref:"</span> + (el.ref) + <span class="string">","</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (el.refInFor) &#123;</span><br><span class="line">    data += <span class="string">"refInFor:true,"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// pre</span></span><br><span class="line">  <span class="keyword">if</span> (el.pre) &#123;</span><br><span class="line">    data += <span class="string">"pre:true,"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// record original tag name for components using "is" attribute</span></span><br><span class="line">  <span class="keyword">if</span> (el.component) &#123;</span><br><span class="line">    data += <span class="string">"tag:\""</span> + (el.tag) + <span class="string">"\","</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// module data generation functions</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; state.dataGenFns.length; i++) &#123;</span><br><span class="line">    data += state.dataGenFns[i](el);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// attributes</span></span><br><span class="line">  <span class="keyword">if</span> (el.attrs) &#123;</span><br><span class="line">    data += <span class="string">"attrs:"</span> + (genProps(el.attrs)) + <span class="string">","</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// DOM props</span></span><br><span class="line">  <span class="keyword">if</span> (el.props) &#123;</span><br><span class="line">    data += <span class="string">"domProps:"</span> + (genProps(el.props)) + <span class="string">","</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// event handlers</span></span><br><span class="line">  <span class="keyword">if</span> (el.events) &#123;</span><br><span class="line">    data += (genHandlers(el.events, <span class="literal">false</span>)) + <span class="string">","</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (el.nativeEvents) &#123;</span><br><span class="line">    data += (genHandlers(el.nativeEvents, <span class="literal">true</span>)) + <span class="string">","</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// slot target</span></span><br><span class="line">  <span class="comment">// only for non-scoped slots</span></span><br><span class="line">  <span class="keyword">if</span> (el.slotTarget &amp;&amp; !el.slotScope) &#123;</span><br><span class="line">    data += <span class="string">"slot:"</span> + (el.slotTarget) + <span class="string">","</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// scoped slots</span></span><br><span class="line">  <span class="keyword">if</span> (el.scopedSlots) &#123;</span><br><span class="line">    data += (genScopedSlots(el, el.scopedSlots, state)) + <span class="string">","</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// component v-model</span></span><br><span class="line">  <span class="keyword">if</span> (el.model) &#123;</span><br><span class="line">    data += <span class="string">"model:&#123;value:"</span> + (el.model.value) + <span class="string">",callback:"</span> + (el.model.callback) + <span class="string">",expression:"</span> + (el.model.expression) + <span class="string">"&#125;,"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// inline-template</span></span><br><span class="line">  <span class="keyword">if</span> (el.inlineTemplate) &#123;</span><br><span class="line">    <span class="keyword">var</span> inlineTemplate = genInlineTemplate(el, state);</span><br><span class="line">    <span class="keyword">if</span> (inlineTemplate) &#123;</span><br><span class="line">      data += inlineTemplate + <span class="string">","</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  data = data.replace(<span class="regexp">/,$/</span>, <span class="string">''</span>) + <span class="string">'&#125;'</span>;</span><br><span class="line">  <span class="comment">// v-bind dynamic argument wrap</span></span><br><span class="line">  <span class="comment">// v-bind with dynamic arguments must be applied using the same v-bind object</span></span><br><span class="line">  <span class="comment">// merge helper so that class/style/mustUseProp attrs are handled correctly.</span></span><br><span class="line">  <span class="keyword">if</span> (el.dynamicAttrs) &#123;</span><br><span class="line">    data = <span class="string">"_b("</span> + data + <span class="string">",\""</span> + (el.tag) + <span class="string">"\","</span> + (genProps(el.dynamicAttrs)) + <span class="string">")"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// v-bind data wrap</span></span><br><span class="line">  <span class="keyword">if</span> (el.wrapData) &#123;</span><br><span class="line">    data = el.wrapData(data);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// v-on data wrap</span></span><br><span class="line">  <span class="keyword">if</span> (el.wrapListeners) &#123;</span><br><span class="line">    data = el.wrapListeners(data);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>走进<code>var dirs = genDirectives(el, state);</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genDirectives</span> (<span class="params">el, state</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> dirs = el.directives;</span><br><span class="line">  <span class="keyword">if</span> (!dirs) &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">  <span class="keyword">var</span> res = <span class="string">'directives:['</span>;</span><br><span class="line">  <span class="keyword">var</span> hasRuntime = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">var</span> i, l, dir, needRuntime;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>, l = dirs.length; i &lt; l; i++) &#123;</span><br><span class="line">    dir = dirs[i];</span><br><span class="line">    needRuntime = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">var</span> gen = state.directives[dir.name];</span><br><span class="line">    <span class="keyword">if</span> (gen) &#123;</span><br><span class="line">      <span class="comment">// compile-time directive that manipulates AST.</span></span><br><span class="line">      <span class="comment">// returns true if it also needs a runtime counterpart.</span></span><br><span class="line">      needRuntime = !!gen(el, dir, state.warn);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (needRuntime) &#123;</span><br><span class="line">      hasRuntime = <span class="literal">true</span>;</span><br><span class="line">      res += <span class="string">"&#123;name:\""</span> + (dir.name) + <span class="string">"\",rawName:\""</span> + (dir.rawName) + <span class="string">"\""</span> + (dir.value ? (<span class="string">",value:("</span> + (dir.value) + <span class="string">"),expression:"</span> + (<span class="built_in">JSON</span>.stringify(dir.value))) : <span class="string">''</span>) + (dir.arg ? (<span class="string">",arg:"</span> + (dir.isDynamicArg ? dir.arg : (<span class="string">"\""</span> + (dir.arg) + <span class="string">"\""</span>))) : <span class="string">''</span>) + (dir.modifiers ? (<span class="string">",modifiers:"</span> + (<span class="built_in">JSON</span>.stringify(dir.modifiers))) : <span class="string">''</span>) + <span class="string">"&#125;,"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (hasRuntime) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.slice(<span class="number">0</span>, <span class="number">-1</span>) + <span class="string">']'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里遍历了<code>el.directives</code>数组，获取指令对应的<code>gen</code>，走进<code>!!gen(el, dir, state.warn);</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">model</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  el,</span></span></span><br><span class="line"><span class="function"><span class="params">  dir,</span></span></span><br><span class="line"><span class="function"><span class="params">  _warn</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  warn$<span class="number">1</span> = _warn;</span><br><span class="line">  <span class="keyword">var</span> value = dir.value;</span><br><span class="line">  <span class="keyword">var</span> modifiers = dir.modifiers;</span><br><span class="line">  <span class="keyword">var</span> tag = el.tag;</span><br><span class="line">  <span class="keyword">var</span> type = el.attrsMap.type;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    <span class="comment">// inputs with type="file" are read only and setting the input's</span></span><br><span class="line">    <span class="comment">// value will throw an error.</span></span><br><span class="line">    <span class="keyword">if</span> (tag === <span class="string">'input'</span> &amp;&amp; type === <span class="string">'file'</span>) &#123;</span><br><span class="line">      warn$<span class="number">1</span>(</span><br><span class="line">        <span class="string">"&lt;"</span> + (el.tag) + <span class="string">" v-model=\""</span> + value + <span class="string">"\" type=\"file\"&gt;:\n"</span> +</span><br><span class="line">        <span class="string">"File inputs are read only. Use a v-on:change listener instead."</span>,</span><br><span class="line">        el.rawAttrsMap[<span class="string">'v-model'</span>]</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (el.component) &#123;</span><br><span class="line">    genComponentModel(el, value, modifiers);</span><br><span class="line">    <span class="comment">// component v-model doesn't need extra runtime</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag === <span class="string">'select'</span>) &#123;</span><br><span class="line">    genSelect(el, value, modifiers);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag === <span class="string">'input'</span> &amp;&amp; type === <span class="string">'checkbox'</span>) &#123;</span><br><span class="line">    genCheckboxModel(el, value, modifiers);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag === <span class="string">'input'</span> &amp;&amp; type === <span class="string">'radio'</span>) &#123;</span><br><span class="line">    genRadioModel(el, value, modifiers);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag === <span class="string">'input'</span> || tag === <span class="string">'textarea'</span>) &#123;</span><br><span class="line">    genDefaultModel(el, value, modifiers);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!config.isReservedTag(tag)) &#123;</span><br><span class="line">    genComponentModel(el, value, modifiers);</span><br><span class="line">    <span class="comment">// component v-model doesn't need extra runtime</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    warn$<span class="number">1</span>(</span><br><span class="line">      <span class="string">"&lt;"</span> + (el.tag) + <span class="string">" v-model=\""</span> + value + <span class="string">"\"&gt;: "</span> +</span><br><span class="line">      <span class="string">"v-model is not supported on this element type. "</span> +</span><br><span class="line">      <span class="string">'If you are working with contenteditable, it\'s recommended to '</span> +</span><br><span class="line">      <span class="string">'wrap a library dedicated for that purpose inside a custom component.'</span>,</span><br><span class="line">      el.rawAttrsMap[<span class="string">'v-model'</span>]</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ensure runtime directive metadata</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>走进<code>genDefaultModel(el, value, modifiers);</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genDefaultModel</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  el,</span></span></span><br><span class="line"><span class="function"><span class="params">  value,</span></span></span><br><span class="line"><span class="function"><span class="params">  modifiers</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> type = el.attrsMap.type;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// warn if v-bind:value conflicts with v-model</span></span><br><span class="line">  <span class="comment">// except for inputs with v-bind:type</span></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> value$<span class="number">1</span> = el.attrsMap[<span class="string">'v-bind:value'</span>] || el.attrsMap[<span class="string">':value'</span>];</span><br><span class="line">    <span class="keyword">var</span> typeBinding = el.attrsMap[<span class="string">'v-bind:type'</span>] || el.attrsMap[<span class="string">':type'</span>];</span><br><span class="line">    <span class="keyword">if</span> (value$<span class="number">1</span> &amp;&amp; !typeBinding) &#123;</span><br><span class="line">      <span class="keyword">var</span> binding = el.attrsMap[<span class="string">'v-bind:value'</span>] ? <span class="string">'v-bind:value'</span> : <span class="string">':value'</span>;</span><br><span class="line">      warn$<span class="number">1</span>(</span><br><span class="line">        binding + <span class="string">"=\""</span> + value$<span class="number">1</span> + <span class="string">"\" conflicts with v-model on the same element "</span> +</span><br><span class="line">        <span class="string">'because the latter already expands to a value binding internally'</span>,</span><br><span class="line">        el.rawAttrsMap[binding]</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> ref = modifiers || &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> lazy = ref.lazy;</span><br><span class="line">  <span class="keyword">var</span> number = ref.number;</span><br><span class="line">  <span class="keyword">var</span> trim = ref.trim;</span><br><span class="line">  <span class="keyword">var</span> needCompositionGuard = !lazy &amp;&amp; type !== <span class="string">'range'</span>;</span><br><span class="line">  <span class="keyword">var</span> event = lazy</span><br><span class="line">    ? <span class="string">'change'</span></span><br><span class="line">    : type === <span class="string">'range'</span></span><br><span class="line">      ? RANGE_TOKEN</span><br><span class="line">      : <span class="string">'input'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> valueExpression = <span class="string">'$event.target.value'</span>;</span><br><span class="line">  <span class="keyword">if</span> (trim) &#123;</span><br><span class="line">    valueExpression = <span class="string">"$event.target.value.trim()"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (number) &#123;</span><br><span class="line">    valueExpression = <span class="string">"_n("</span> + valueExpression + <span class="string">")"</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> code = genAssignmentCode(value, valueExpression);</span><br><span class="line">  <span class="keyword">if</span> (needCompositionGuard) &#123;</span><br><span class="line">    code = <span class="string">"if($event.target.composing)return;"</span> + code;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  addProp(el, <span class="string">'value'</span>, (<span class="string">"("</span> + value + <span class="string">")"</span>));</span><br><span class="line">  addHandler(el, event, code, <span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">if</span> (trim || number) &#123;</span><br><span class="line">    addHandler(el, <span class="string">'blur'</span>, <span class="string">'$forceUpdate()'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">addProp(el, <span class="string">'value'</span>, (<span class="string">"("</span> + value + <span class="string">")"</span>));</span><br><span class="line">addHandler(el, event, code, <span class="literal">null</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<p>其中的这两个方法，给 <code>el</code> 添加一个 <code>prop</code>，相当于我们在 <code>input</code> 上动态绑定了 <code>value</code>，又给 <code>el</code> 添加了事件处理，相当于在 <code>input</code> 上绑定了 <code>input</code> 事件</p>
<p><img src="http://114.55.30.96/WX20190906-161250@2x.png" alt="WX20190906-161250@2x"></p>
<p>然后上面<code>var dirs = genDirectives(el, state);</code>返回的<code>dirs</code>就是这样的</p>
<p><img src="http://114.55.30.96/WX20190906-161533@2x.png" alt="WX20190906-161533@2x"></p>
<p>最终获得的<code>render</code>方法是这样的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"with(this)&#123;return _c('div',[_c('input',&#123;directives:[&#123;name:"</span>model<span class="string">",rawName:"</span>v-model<span class="string">",value:(message),expression:"</span>message<span class="string">"&#125;],domProps:&#123;"</span>value<span class="string">":(message)&#125;,on:&#123;"</span>input<span class="string">":function($event)&#123;if($event.target.composing)return;message=$event.target.value&#125;&#125;&#125;),_v("</span>\n    <span class="string">"+_s(message)+"</span>\n  <span class="string">")])&#125;"</span></span><br></pre></td></tr></table></figure>
<p>往后走到调用<code>render</code>方法的地方</p>
<p><img src="http://114.55.30.96/WX20190906-165558@2x.png" alt="WX20190906-165558@2x"></p>
<p>顺便补充一下这个<code>vm._renderProxy</code>，其实就是<code>new Proxy(vm,handlers)</code>返回的实例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">initProxy = <span class="function"><span class="keyword">function</span> <span class="title">initProxy</span> (<span class="params">vm</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (hasProxy) &#123;</span><br><span class="line">    <span class="comment">// determine which proxy handler to use</span></span><br><span class="line">    <span class="keyword">var</span> options = vm.$options;</span><br><span class="line">    <span class="keyword">var</span> handlers = options.render &amp;&amp; options.render._withStripped</span><br><span class="line">      ? getHandler</span><br><span class="line">      : hasHandler;</span><br><span class="line">    vm._renderProxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(vm, handlers);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    vm._renderProxy = vm;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这个是<code>input</code>生成的<code>vnode</code></p>
<p><img src="http://114.55.30.96/WX20190906-171617@2x.png" alt="WX20190906-171617@2x"></p>
<p>走进去<code>update</code>方法看下<code>patch</code>阶段做了什么，进入<code>createElm</code>方法里的<code>createChildren</code>方法（这里是创建的是<code>div</code>标签的<code>children</code>）</p>
<p><img src="http://114.55.30.96/WX20190906-174914@2x.png" alt="WX20190906-174914@2x"></p>
<p><img src="http://114.55.30.96/WX20190906-172113@2x.png" alt="WX20190906-172113@2x"></p>
<p>又会走到<code>createElm</code>，这里是<code>input</code>标签的了</p>
<p><img src="http://114.55.30.96/WX20190906-175418@2x.png" alt="WX20190906-175418@2x"></p>
<p>进入<code>invokeCreateHooks</code>方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">invokeCreateHooks</span> (<span class="params">vnode, insertedVnodeQueue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i$<span class="number">1</span> = <span class="number">0</span>; i$<span class="number">1</span> &lt; cbs.create.length; ++i$<span class="number">1</span>) &#123;</span><br><span class="line">    cbs.create[i$<span class="number">1</span>](emptyNode, vnode);</span><br><span class="line">  &#125;</span><br><span class="line">  i = vnode.data.hook; <span class="comment">// Reuse variable</span></span><br><span class="line">  <span class="keyword">if</span> (isDef(i)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDef(i.create)) &#123; i.create(emptyNode, vnode); &#125;</span><br><span class="line">    <span class="keyword">if</span> (isDef(i.insert)) &#123; insertedVnodeQueue.push(vnode); &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://114.55.30.96/WX20190906-180033@2x.png" alt="WX20190906-180033@2x"></p>
<p><code>updateDOMListeners</code>方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateDOMListeners</span> (<span class="params">oldVnode, vnode</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isUndef(oldVnode.data.on) &amp;&amp; isUndef(vnode.data.on)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> on = vnode.data.on || &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> oldOn = oldVnode.data.on || &#123;&#125;;</span><br><span class="line">  target$<span class="number">1</span> = vnode.elm;</span><br><span class="line">  normalizeEvents(on);</span><br><span class="line">  updateListeners(on, oldOn, add$<span class="number">1</span>, remove$<span class="number">2</span>, createOnceHandler$<span class="number">1</span>, vnode.context);</span><br><span class="line">  target$<span class="number">1</span> = <span class="literal">undefined</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>走进<code>updateListeners</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateListeners</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  on,</span></span></span><br><span class="line"><span class="function"><span class="params">  oldOn,</span></span></span><br><span class="line"><span class="function"><span class="params">  add,</span></span></span><br><span class="line"><span class="function"><span class="params">  remove$$<span class="number">1</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  createOnceHandler,</span></span></span><br><span class="line"><span class="function"><span class="params">  vm</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> name, def$$<span class="number">1</span>, cur, old, event;</span><br><span class="line">  <span class="keyword">for</span> (name <span class="keyword">in</span> on) &#123;</span><br><span class="line">    def$$<span class="number">1</span> = cur = on[name];</span><br><span class="line">    old = oldOn[name];</span><br><span class="line">    event = normalizeEvent(name);</span><br><span class="line">    <span class="keyword">if</span> (isUndef(cur)) &#123;</span><br><span class="line">      process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; warn(</span><br><span class="line">        <span class="string">"Invalid handler for event \""</span> + (event.name) + <span class="string">"\": got "</span> + <span class="built_in">String</span>(cur),</span><br><span class="line">        vm</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isUndef(old)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isUndef(cur.fns)) &#123;</span><br><span class="line">        cur = on[name] = createFnInvoker(cur, vm);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (isTrue(event.once)) &#123;</span><br><span class="line">        cur = on[name] = createOnceHandler(event.name, cur, event.capture);</span><br><span class="line">      &#125;</span><br><span class="line">      add(event.name, cur, event.capture, event.passive, event.params);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cur !== old) &#123;</span><br><span class="line">      old.fns = cur;</span><br><span class="line">      on[name] = old;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (name <span class="keyword">in</span> oldOn) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isUndef(on[name])) &#123;</span><br><span class="line">      event = normalizeEvent(name);</span><br><span class="line">      remove$$<span class="number">1</span>(event.name, oldOn[name], event.capture);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>走进<code>add(event.name, cur, event.capture, event.passive, event.params);</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add$1</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  name,</span></span></span><br><span class="line"><span class="function"><span class="params">  handler,</span></span></span><br><span class="line"><span class="function"><span class="params">  capture,</span></span></span><br><span class="line"><span class="function"><span class="params">  passive</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (useMicrotaskFix) &#123;</span><br><span class="line">    <span class="keyword">var</span> attachedTimestamp = currentFlushTimestamp;</span><br><span class="line">    <span class="keyword">var</span> original = handler;</span><br><span class="line">    handler = original._wrapper = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        e.target === e.currentTarget ||</span><br><span class="line">        e.timeStamp &gt;= attachedTimestamp ||</span><br><span class="line">        e.timeStamp &lt;= <span class="number">0</span> ||</span><br><span class="line">        e.target.ownerDocument !== <span class="built_in">document</span></span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="keyword">return</span> original.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  target$<span class="number">1.</span>addEventListener(</span><br><span class="line">    name,</span><br><span class="line">    handler,</span><br><span class="line">    supportsPassive</span><br><span class="line">      ? &#123; <span class="attr">capture</span>: capture, <span class="attr">passive</span>: passive &#125;</span><br><span class="line">      : capture</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里添加绑定事件</p>
<p><img src="http://114.55.30.96/WX20190906-185324@2x.png" alt="WX20190906-185324@2x"></p>
<p>触发一下绑定<code>input</code>事件</p>
<p><img src="http://114.55.30.96/WX20190906-185653@2x.png" alt="WX20190906-185653@2x"></p>
<p><img src="http://114.55.30.96/WX20190906-185841@2x.png" alt="WX20190906-185841@2x"></p>
<p>就是调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">$event</span>)</span>&#123;<span class="keyword">if</span>($event.target.composing)<span class="keyword">return</span>;message=$event.target.value&#125;</span><br></pre></td></tr></table></figure>
<p>然后又触发<code>setter</code></p>
<p><img src="http://114.55.30.96/WX20190906-190059@2x.png" alt="WX20190906-190059@2x"></p>
<p>后面就不写了</p>
<p><strong>总的来说就是</strong></p>
<p>1）在模板解析，生成<code>render</code>方法的时候，为<code>input</code>的<code>el</code>先添加了<code>events</code>属性，之后又判断有<code>events</code>属性的话，生成的<code>data</code>做字符串拼接(最后拼接到<code>render</code>方法里的字符串)</p>
<p><img src="http://114.55.30.96/WX20190907-123004@2x.png" alt="WX20190907-123004@2x"></p>
<p>2）在调用<code>render</code>方法生成<code>vnode</code>以后，在<code>update</code>的<code>patch</code>阶段，为DOM元素增加事件</p>
<h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h2><p>为什么不能直接通过索引，或者通过<code>length</code>属性修改值，在响应式原理有写。</p>
<p>其实Object.defineProperty本身有一定的监控到数组下标变化的能力，因为性能问题，所以没有使用到。</p>
<p>Vue 的响应式原理中 Object.defineProperty 有什么缺陷？为什么在 Vue3.0 采用了 Proxy，抛弃了 Object.defineProperty？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Object.defineProperty只能劫持对象的属性，从而需要对每个对象，每个属性进行遍历，如果，属性值是对象，还需要深度遍历。Proxy可以劫持整个对象，并返回一个新的对象。</span><br><span class="line"></span><br><span class="line">Proxy不仅可以代理对象，还可以代理数组。还可以代理动态增加的属性。</span><br></pre></td></tr></table></figure>
<h2 id="nextTick"><a href="#nextTick" class="headerlink" title="nextTick"></a>nextTick</h2><p>这个方法接收到参数后，把参数包在匿名函数中<code>push</code>进<code>callbacks</code>数组，然后把一个方法加到微任务队列或者宏任务队列，加进去的方法就是遍历<code>callbacks</code>调用匿名函数。</p>
<h2 id="Vue-组件中-data-为什么必须是函数"><a href="#Vue-组件中-data-为什么必须是函数" class="headerlink" title="Vue 组件中 data 为什么必须是函数"></a>Vue 组件中 data 为什么必须是函数</h2><p>先看错误提示在哪</p>
<p>在子组件做<code>mergeOptions</code>的时候</p>
<p><img src="http://114.55.30.96/WX20190908-233124@2x.png" alt="WX20190908-233124@2x"></p>
<p>如果<code>childVal</code>不是<code>function</code>类型就会提示</p>
<p><img src="http://114.55.30.96/WX20190908-233206@2x.png" alt="WX20190908-233206@2x"></p>
<p>因为：</p>
<p>在组件创建实例做参数合并的时候，看一下<code>data</code>，合并参数后返回的是这个方法，其中的<code>childVal</code>是<code>new Vue(options)</code>，中的<code>options</code>中<code>data</code>的引用地址</p>
<p><img src="http://114.55.30.96/WX20190908-234713@2x.png" alt="WX20190908-234713@2x"></p>
<p>然后在<code>initData</code>的时候，获取<code>data</code></p>
<p><img src="http://114.55.30.96/WX20190908-234921@2x.png" alt="WX20190908-234921@2x"></p>
<p>然后我去修改<code>data</code>的值</p>
<p><img src="http://114.55.30.96/WX20190908-235121@2x.png" alt="WX20190908-235121@2x"></p>
<p>然后看下<code>new Vue(options)</code></p>
<p><img src="http://114.55.30.96/WX20190908-235121@2x.png" alt="WX20190908-235121@2x"></p>
<p>也就是说，在组件创建实例的时候，<code>data</code>如果是对象的话，每个组件的实例修改<code>data</code>的值，会有影响，所以使用方法可以让每个实例的<code>data</code>独立</p>
<h2 id="自定义事件通知"><a href="#自定义事件通知" class="headerlink" title="自定义事件通知"></a>自定义事件通知</h2><p>emm…，意思其实就是子组件通知父组件啦</p>
<p>main.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App'</span>;</span><br><span class="line">Vue.config.productionTip = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* eslint-disable no-new */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  methods:&#123;</span><br><span class="line">    childEmitHandler() &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Child select!'</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    childEmitHandler1() &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Child select1!'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  components:&#123;</span><br><span class="line">    App</span><br><span class="line">  &#125;,</span><br><span class="line">  template: <span class="string">`&lt;div&gt; </span></span><br><span class="line"><span class="string">  &lt;App @childEmitHandler="childEmitHandler();childEmitHandler1()" /&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;`</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>App.vue</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;button @click=<span class="string">"clickHandler($event)"</span>&gt;click me&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  name: <span class="string">"App"</span>,</span><br><span class="line">  props: &#123;</span><br><span class="line">    firstName: <span class="built_in">String</span></span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    clickHandler(e) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'child clicked'</span>);</span><br><span class="line">      <span class="keyword">this</span>.$emit(<span class="string">"childEmitHandler"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
<p>写个大概吧。</p>
<p>1）父组件初始化的时候，<code>initState</code>的时候，<code>childEmitHandler</code>强绑定<code>this</code>后挂载到<code>vm</code>实例上，在<code>update</code>阶段的时候为元素添加事件</p>
<p><img src="http://114.55.30.96/WX20190909-082624@2x.png" alt="WX20190909-082624@2x"></p>
<p>2）子组件初始化的时候，<code>initEvents</code>的时候，添加自定义事件进<code>vm._events</code>对象</p>
<p><img src="http://114.55.30.96/WX20190909-084215@2x.png" alt="WX20190909-084215@2x"></p>
<p><img src="http://114.55.30.96/WX20190909-002952@2x.png" alt="WX20190909-002952@2x"></p>
<p>然后<code>initState</code>的时候<code>clickHandler</code>绑定<code>this</code>后挂载在实例上，在<code>update</code>阶段的时候为元素添加事件。</p>
<p>3）触发子组件点击事件，调用<code>$emit</code>方法通知调用自定义事件，遍历<code>vm._events[event]</code>，调用每一项的方法调用</p>
<p><img src="http://114.55.30.96/WX20190909-084428@2x.png" alt="WX20190909-084428@2x"></p>
<p><img src="http://114.55.30.96/WX20190909-084607@2x.png" alt="WX20190909-084607@2x"></p>
<p>并且得知，事件是可以绑定多个方法的</p>
<p><strong>总结结</strong></p>
<ul>
<li>子组件创建实例的时候，传入了options里包含父vnode，父vnode里包含了自定义事件。子组件init进入initEvent的时候挂载到了子组件实例的_events上</li>
<li>$emit方法调用的时候，从vm._events上取得回调，并调用</li>
</ul>
<p>​    </p>
<h2 id="vue中-key-值的作用"><a href="#vue中-key-值的作用" class="headerlink" title="vue中 key 值的作用"></a>vue中 <code>key</code> 值的作用</h2><p>写两个例子，分别<code>带key</code>和<code>不带key</code>的情况</p>
<p><strong>不带key</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App'</span>;</span><br><span class="line">Vue.config.productionTip = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* eslint-disable no-new */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  data:&#123;</span><br><span class="line">    userList:[&#123;</span><br><span class="line">      name:<span class="string">"qinhanwen"</span>,</span><br><span class="line">      id:<span class="number">1</span>,</span><br><span class="line">    &#125;,&#123;</span><br><span class="line">      name:<span class="string">"zenghua"</span>,</span><br><span class="line">      id:<span class="number">2</span>,</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;,</span><br><span class="line">  methods:&#123;</span><br><span class="line">    reverseUserList() &#123;</span><br><span class="line">      <span class="keyword">this</span>.userList.reverse();</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  template: <span class="string">`&lt;ul @click="reverseUserList()"&gt; </span></span><br><span class="line"><span class="string">    &lt;li v-for="item in userList"&gt;&#123;&#123;item.name&#125;&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="string">  &lt;/ul&gt;`</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>1）触发点击事件</p>
<p>2）更新<code>vnode</code></p>
<p>3）触发<code>DOM</code>更新</p>
<p>当没有key的时候（<code>key</code>是<code>undefined</code>），<code>sameVnode(oldStartVnode, newStartVnode)</code>方法的返回值为<code>true</code>，选择复用之前的<code>DOM</code>结构，也就是<code>DOM</code>元素不变，去改变它的<code>children</code>（当前这个元素是第一个<code>li</code>元素）</p>
<p><img src="http://114.55.30.96/WX20190909-101749@2x.png" alt="WX20190909-101749@2x"></p>
<p>当前元素的<code>children</code>的值更新了</p>
<p><img src="http://114.55.30.96/WX20190909-102602@2x.png" alt="WX20190909-102602@2x"></p>
<p>之后再改变另外一个<code>li</code>元素的<code>children</code></p>
<p><img src="http://114.55.30.96/WX20190909-103118@2x.png" alt="WX20190909-103118@2x"></p>
<p><strong>带key</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App'</span>;</span><br><span class="line">Vue.config.productionTip = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* eslint-disable no-new */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  data:&#123;</span><br><span class="line">    userList:[&#123;</span><br><span class="line">      name:<span class="string">"qinhanwen"</span>,</span><br><span class="line">      id:<span class="number">1</span>,</span><br><span class="line">    &#125;,&#123;</span><br><span class="line">      name:<span class="string">"zenghua"</span>,</span><br><span class="line">      id:<span class="number">2</span>,</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;,</span><br><span class="line">  methods:&#123;</span><br><span class="line">    reverseUserList() &#123;</span><br><span class="line">      <span class="keyword">this</span>.userList.reverse();</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  template: <span class="string">`&lt;ul @click="reverseUserList()"&gt; </span></span><br><span class="line"><span class="string">    &lt;li v-for="item in userList" key="item.id"&gt;&#123;&#123;item.name&#125;&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="string">  &lt;/ul&gt;`</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>1）触发点击事件</p>
<p>2）更新<code>vnode</code></p>
<p>3）触发<code>DOM</code>更新</p>
<p>这时候因为有<code>key</code>，所以<code>sameVnode(oldStartVnode, newStartVnode)</code>方法返回值为<code>false</code></p>
<p><img src="http://114.55.30.96/WX20190909-103558@2x.png" alt="WX20190909-103558@2x"></p>
<p>所以走进了另外一个处理分支，<code>sameVnode(oldStartVnode, newEndVnode)</code>返回为<code>true</code>，把现有元素通过<code>insertBefore</code>移动到前面</p>
<p><img src="http://114.55.30.96/WX20190909-104124@2x.png" alt="WX20190909-104124@2x"></p>
<p><strong>总结：</strong></p>
<p><code>带key</code>：根据key的变化，来重新排列元素顺序，更新<code>DOM</code>结构。</p>
<p><code>不带key</code>：没有 <code>key</code> 的值会采取一种“就地更新策略”，更新现有的<code>DOM</code>节点和它的<code>children</code>，（有可能会做很多创建、删除节点之类的，相对来说效率更低一点）。</p>
<h2 id="为什么key不建议使用index"><a href="#为什么key不建议使用index" class="headerlink" title="为什么key不建议使用index"></a>为什么key不建议使用index</h2><p>写两个例子</p>
<p><strong><code>key</code>为<code>index</code></strong></p>
<p>main.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App'</span>;</span><br><span class="line">Vue.config.productionTip = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* eslint-disable no-new */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  data:&#123;</span><br><span class="line">    userList:[&#123;</span><br><span class="line">      name:<span class="string">"qinhanwen"</span>,</span><br><span class="line">      id:<span class="number">1</span>,</span><br><span class="line">    &#125;,&#123;</span><br><span class="line">      name:<span class="string">"zenghua"</span>,</span><br><span class="line">      id:<span class="number">2</span>,</span><br><span class="line">    &#125;,&#123;</span><br><span class="line">      name:<span class="string">"bao"</span>,</span><br><span class="line">      id:<span class="number">3</span>,</span><br><span class="line">    &#125;,&#123;</span><br><span class="line">      name:<span class="string">"guo"</span>,</span><br><span class="line">      id:<span class="number">4</span>,</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;,</span><br><span class="line">  methods:&#123;</span><br><span class="line">    reverseUserList() &#123;</span><br><span class="line">      <span class="keyword">this</span>.userList.splice(<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  template: <span class="string">`&lt;ul @click="reverseUserList()"&gt; </span></span><br><span class="line"><span class="string">    &lt;li v-for="(item,index) in userList" :key="index"&gt;&#123;&#123;item.name&#125;&#125;&#123;&#123;index&#125;&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="string">  &lt;/ul&gt;`</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>1）触发点击事件</p>
<p>2）更新<code>vnode</code></p>
<p>3）</p>
<ul>
<li><p>第一个<code>li</code>无变化，没有重新渲染</p>
</li>
<li><p>第二个<code>li</code>被重新渲染</p>
<p><img src="http://114.55.30.96/WX20190909-125426@2x.png" alt="WX20190909-125426@2x"></p>
</li>
<li><p>第三个<code>li</code>被重新渲染</p>
<p><img src="http://114.55.30.96/WX20190909-125530@2x.png" alt="WX20190909-125530@2x"></p>
</li>
<li><p>第四个<code>li</code>被移除</p>
</li>
</ul>
<p><strong><code>key</code>为<code>id</code></strong></p>
<p>main.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App'</span>;</span><br><span class="line">Vue.config.productionTip = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* eslint-disable no-new */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  data:&#123;</span><br><span class="line">    userList:[&#123;</span><br><span class="line">      name:<span class="string">"qinhanwen"</span>,</span><br><span class="line">      id:<span class="number">1</span>,</span><br><span class="line">    &#125;,&#123;</span><br><span class="line">      name:<span class="string">"zenghua"</span>,</span><br><span class="line">      id:<span class="number">2</span>,</span><br><span class="line">    &#125;,&#123;</span><br><span class="line">      name:<span class="string">"bao"</span>,</span><br><span class="line">      id:<span class="number">3</span>,</span><br><span class="line">    &#125;,&#123;</span><br><span class="line">      name:<span class="string">"guo"</span>,</span><br><span class="line">      id:<span class="number">4</span>,</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;,</span><br><span class="line">  methods:&#123;</span><br><span class="line">    reverseUserList() &#123;</span><br><span class="line">      <span class="keyword">this</span>.userList.splice(<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  template: <span class="string">`&lt;ul @click="reverseUserList()"&gt; </span></span><br><span class="line"><span class="string">    &lt;li v-for="(item,index) in userList" :key="item.id"&gt;&#123;&#123;item.name&#125;&#125;&#123;&#123;index&#125;&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="string">  &lt;/ul&gt;`</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>1）触发点击事件</p>
<p>2）更新<code>vnode</code></p>
<p>3）</p>
<ul>
<li><p>第一个<code>li</code>无变化，没有重新渲染</p>
</li>
<li><p>第四个<code>li</code>的更新内容</p>
<p><img src="http://114.55.30.96/WX20190909-130108@2x.png" alt="WX20190909-130108@2x"></p>
</li>
<li><p>第三个<code>li</code>更新内容</p>
<p><img src="http://114.55.30.96/WX20190909-130256@2x.png" alt="WX20190909-130256@2x"></p>
</li>
<li><p>移除第二个<code>li</code></p>
</li>
</ul>
<p><strong>总结：</strong></p>
<p><code>key</code>为<code>index</code>：当移除数组的某一项，某项开始到之后的所有节点都会被重新渲染</p>
<p><code>key</code>为<code>id</code>：尽可能复用相同的<code>id</code>的节点（因为插值表达式写了<code>index</code>，才做了渲染），只移除需要移除的那一项。</p>
<h2 id="v-show和v-if指令的共同点和不同点"><a href="#v-show和v-if指令的共同点和不同点" class="headerlink" title="v-show和v-if指令的共同点和不同点"></a>v-show和v-if指令的共同点和不同点</h2><p><code>v-show</code>指令是通过修改元素的<code>display</code>CSS属性让其显示或者隐藏</p>
<p><code>v-if</code>指令是直接销毁和重建DOM达到让元素显示和隐藏的效果（注意：v-if 可以实现组件的重新渲染）</p>
<h2 id="route与-router"><a href="#route与-router" class="headerlink" title="\$route与\$router"></a>\$route与\$router</h2><p><code>Vue.use(VueRouter)</code>后，在执行<code>install</code>方法的时候，除了安装了两个生命周期函数和全局组件，还为<code>vm.$router</code>和<code>vm.$route</code>添加了<code>get</code></p>
<p><img src="http://114.55.30.96/WX20190909-221338@2x.png" alt="WX20190909-221338@2x"></p>
<p>在<code>new VueRouter({routes})</code>的时候，创建路由注册表，下面是创建的实例</p>
<p><img src="http://114.55.30.96/WX20190909-222713@2x.png" alt="WX20190909-222713@2x"></p>
<p>它的<code>__proto__</code>属性：</p>
<p><img src="http://114.55.30.96/WX20190909-225609@2x.png" alt="WX20190909-225609@2x"></p>
<p>在<code>init</code>初始化，执行<code>callHook(vm, &#39;beforeCreate&#39;);</code>，也就是调用<code>install</code>的时候添加的<code>beforeCreate</code>生命周期钩子函数，在这里做路由初始化</p>
<p><code>$router</code>就是<code>VueRouter</code>的实例</p>
<p><img src="http://114.55.30.96/WX20190909-224918@2x.png" alt="WX20190909-224918@2x"></p>
<p>监听路由变化</p>
<p><img src="http://114.55.30.96/WX20190909-224041@2x.png" alt="WX20190909-224041@2x"></p>
<p>然后<code>$route</code>在这里赋值</p>
<p><img src="http://114.55.30.96/WX20190909-225316@2x.png" alt="WX20190909-225316@2x"></p>
<p><img src="http://114.55.30.96/WX20190909-225405@2x.png" alt="WX20190909-225405@2x"></p>
<p><strong>总结：</strong></p>
<p><code>$router</code>：路由器对象，提供了系列跳转相关的方法。</p>
<p><code>$route</code>：相当于当前正在跳转的路由对象。</p>
<h2 id="插槽"><a href="#插槽" class="headerlink" title="插槽"></a>插槽</h2><p>main.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App'</span>;</span><br><span class="line">Vue.config.productionTip = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* eslint-disable no-new */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  data: &#123;</span><br><span class="line">    name: <span class="string">'qinhanwen'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  components: &#123;</span><br><span class="line">    App</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line">  template: <span class="string">`&lt;App&gt;&lt;p slot="content"&gt;&#123;&#123;name&#125;&#125;&lt;/p&gt;&lt;/App&gt;`</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>app.vue</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;slot name=&quot;content&quot;&gt;&lt;/slot&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;App&quot;,</span><br><span class="line">  props: &#123;</span><br><span class="line">    firstName: String</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>在父组件模板解析生成<code>render</code>方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span>(<span class="keyword">this</span>)&#123;<span class="keyword">return</span> _c(<span class="string">'App'</span>,[_c(<span class="string">'p'</span>,&#123;<span class="attr">attrs</span>:&#123;<span class="string">"slot"</span>:<span class="string">"content"</span>&#125;,<span class="attr">slot</span>:<span class="string">"content"</span>&#125;,[_v(_s(name))])])&#125;</span><br></pre></td></tr></table></figure>
<p>因为<code>App</code>是个组件，所以开始创建组件，进入组件<code>init</code>，在<code>initInternalComponent</code>的时候，拿到<code>App</code>组件<code>vnode</code>里的<code>子vnode</code>，就是那个<code>p</code>标签的<code>vnode</code></p>
<p><img src="http://114.55.30.96/WX20190910-210255@2x.png" alt="WX20190910-210255@2x"></p>
<p>在<code>initRender</code>的时候为子组件<code>vm</code>添加<code>$slots</code>属性</p>
<p><img src="http://114.55.30.96/WX20190910-204120@2x.png" alt="WX20190910-204120@2x"></p>
<p>然后进入子组件挂载阶段</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">child.$mount(hydrating ? vnode.elm : <span class="literal">undefined</span>, hydrating);</span><br></pre></td></tr></table></figure>
<p>进入<code>_render</code>方法，<code>vm.$scopedSlots</code>等于这么个方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (_parentVnode) &#123;</span><br><span class="line">    vm.$scopedSlots = normalizeScopedSlots(</span><br><span class="line">      _parentVnode.data.scopedSlots,</span><br><span class="line">      vm.$slots,</span><br><span class="line">      vm.$scopedSlots</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://114.55.30.96/WX20190910-205350@2x.png" alt="WX20190910-205350@2x"></p>
<p>生成<code>vnode</code></p>
<p><code>vnode = render.call(vm._renderProxy, vm.$createElement);</code></p>
<p>进入<code>render</code>方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> render = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _vm = <span class="keyword">this</span></span><br><span class="line">  <span class="keyword">var</span> _h = _vm.$createElement</span><br><span class="line">  <span class="keyword">var</span> _c = _vm._self._c || _h</span><br><span class="line">  <span class="keyword">return</span> _c(<span class="string">"div"</span>, [_vm._t(<span class="string">"content"</span>)], <span class="number">2</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看一下<code>_vm._t</code>方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderSlot</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  name,</span></span></span><br><span class="line"><span class="function"><span class="params">  fallback,</span></span></span><br><span class="line"><span class="function"><span class="params">  props,</span></span></span><br><span class="line"><span class="function"><span class="params">  bindObject</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> scopedSlotFn = <span class="keyword">this</span>.$scopedSlots[name];</span><br><span class="line">  <span class="keyword">var</span> nodes;</span><br><span class="line">  <span class="keyword">if</span> (scopedSlotFn) &#123; <span class="comment">// scoped slot</span></span><br><span class="line">    props = props || &#123;&#125;;</span><br><span class="line">    <span class="keyword">if</span> (bindObject) &#123;</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; !isObject(bindObject)) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          <span class="string">'slot v-bind without argument expects an Object'</span>,</span><br><span class="line">          <span class="keyword">this</span></span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      props = extend(extend(&#123;&#125;, bindObject), props);</span><br><span class="line">    &#125;</span><br><span class="line">    nodes = scopedSlotFn(props) || fallback;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    nodes = <span class="keyword">this</span>.$slots[name] || fallback;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> target = props &amp;&amp; props.slot;</span><br><span class="line">  <span class="keyword">if</span> (target) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$createElement(<span class="string">'template'</span>, &#123; <span class="attr">slot</span>: target &#125;, nodes)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> nodes</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回的<code>nodes</code>就是这个，就是那个<code>p</code>标签的<code>vnode</code></p>
<p><img src="http://114.55.30.96/WX20190910-212407@2x.png" alt="WX20190910-212407@2x"></p>
<p>然后调用<code>_c</code>，就是<code>_createElement</code>方法，最后生成的<code>vnode</code>大概是这样的</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">		tag:"div",</span><br><span class="line">		children:[</span><br><span class="line">			&#123;</span><br><span class="line">				tag:"p",</span><br><span class="line">				children:[</span><br><span class="line">					&#123;</span><br><span class="line">						tag:undefined,</span><br><span class="line">						text:"qinhanwen"</span><br><span class="line">						...</span><br><span class="line">					&#125;</span><br><span class="line">				]</span><br><span class="line">				...</span><br><span class="line">			&#125;</span><br><span class="line">		]</span><br><span class="line">		...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后面就不写了</p>
<p><strong>总结：</strong></p>
<p>也就是一开始父组件里使用组件的地方，组件标签里的模板，变成了<code>vnode</code>被存了起来，在子组件<code>_render</code>的时候被拿出来插到插槽的位置。</p>
<h2 id="计算属性与监听属性"><a href="#计算属性与监听属性" class="headerlink" title="计算属性与监听属性"></a>计算属性与监听属性</h2><p><strong>计算属性：</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"></span><br><span class="line">Vue.config.productionTip = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* eslint-disable no-new */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  data: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      firstName: <span class="string">'qin'</span>,</span><br><span class="line">      lastName: <span class="string">'hanwen'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods:&#123;</span><br><span class="line">    changeFirstName()&#123;</span><br><span class="line">      <span class="keyword">this</span>.firstName = <span class="string">'q'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  computed: &#123;</span><br><span class="line">    totalName: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.firstName + <span class="keyword">this</span>.lastName</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  template: <span class="string">`&lt;div @click="changeFirstName()"&gt;</span></span><br><span class="line"><span class="string">  &#123;&#123;totalName&#125;&#125;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;`</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>initState</code>进入到<code>initComputed</code>的时候，遍历计算属性</p>
<ul>
<li>添加计算属性<code>watcher</code>，<code>push</code>到<code>vm._watchers</code>，<code>watcher</code>的<code>getter</code>方法就是计算属性的函数</li>
<li>为<code>vm</code>上的<code>计算属性键名</code>，添加属性描述符（<code>getter</code>、<code>setter</code>、<code>configurable</code>、<code>enumerable</code>)</li>
</ul>
</li>
<li><p>调用<code>vm._render()</code>，生成<code>vnode</code>的过程中</p>
<ul>
<li><p>取<code>totalName</code>的值，触发<code>getter</code>（这里就是触发<code>totalName</code>计算属性的方法调用，其中又触发<code>firstName</code>和<code>lastName</code>的<code>getter</code>，就把当前这个<code>totalName</code>的<code>watcher</code>收集了，另外还收集了渲染<code>watcher</code>）</p>
</li>
<li><p>生成<code>vnode</code></p>
</li>
</ul>
</li>
<li><p>触发点击事件，修改<code>firstName</code>的值，触发派发更新的过程</p>
<ul>
<li>因为计算属性的<code>watcher</code>是<code>lazy</code>，所以没能加到<code>queue</code>队列里</li>
<li>将渲染<code>watcher</code>加入到<code>queue</code>队列</li>
<li>之后通过<code>nextTick</code>添加异步任务，遍历<code>queue</code>执行里面<code>watcher</code>的<code>run</code>方法，也就是重新执行<code>vm._update(vm._render(), hydrating);</code>，生成<code>vnode</code>的时候，更新<code>totalName</code>的数据</li>
<li>重新渲染</li>
</ul>
</li>
</ul>
<p><strong>监听属性：</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"></span><br><span class="line">Vue.config.productionTip = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* eslint-disable no-new */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  data: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      firstName: <span class="string">'qin'</span>,</span><br><span class="line">      totalName: <span class="string">'total'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods:&#123;</span><br><span class="line">    changeFirstName()&#123;</span><br><span class="line">      <span class="keyword">this</span>.firstName = <span class="string">'q'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  watch: &#123;</span><br><span class="line">    firstName: <span class="function"><span class="keyword">function</span> (<span class="params">newVal,oldVal</span>) </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.totalName =  newVal + oldVal;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  template: <span class="string">`&lt;div @click="changeFirstName()"&gt;</span></span><br><span class="line"><span class="string">  &#123;&#123;totalName&#125;&#125;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;`</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>initState</code>进入到<code>initWatch</code>的时候，遍历监听属性</p>
<ul>
<li><p>添加<code>user watcher</code>，<code>push</code>到<code>vm._watchers</code>，<code>user watcher</code>的<code>cb</code>属性是<code>watch</code>属性的回调函数，<code>getter</code>是这个方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; segments.length; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!obj) &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">      obj = obj[segments[i]];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> obj</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建<code>user watcher</code>实例的最后，调用<code>this.get() -&gt; this.getter.call(vm, vm)</code>，<code>getter</code>就是上面这个方法，<code>obj[segments[i]]</code>的时候触发<code>firstName</code>的<code>getter</code>，把这个<code>user watcher</code>做依赖收集，添加到了<code>firstName</code>的<code>dep</code>里</p>
</li>
<li><p>判断是否有<code>immediate</code>属性，有就立即执行<code>cb</code></p>
</li>
</ul>
</li>
<li><p>触发点击事件，改变<code>firstName</code>的值，触发派发更新</p>
<ul>
<li><p>调用刚才依赖收集到的<code>user watcher</code>的<code>run</code>方法，先获取了<code>val</code>，也获取了<code>oldVal</code>，然后调用<code>user watcher</code>的<code>cb</code>函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.cb.call(<span class="keyword">this</span>.vm, value, oldValue);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p><strong>所以监听属性与计算属性的区别：</strong></p>
<p><strong>计算属性：</strong>在<code>render</code>生成<code>vnode</code>的时候做依赖收集，也是在依赖是属性发生变化的时候，才重新生成<code>vnode</code>，重新渲染。</p>
<p><strong>监听属性：</strong>在创建<code>user watcher</code>实例的时候，就做了依赖收集，在<code>watch</code>的值改变的时候，会调用<code>watch</code>属性的回调（监听属性比较适合做一些复杂的逻辑）。</p>
<h2 id="v-if与v-for不建议使用在同一个模板"><a href="#v-if与v-for不建议使用在同一个模板" class="headerlink" title="v-if与v-for不建议使用在同一个模板"></a>v-if与v-for不建议使用在同一个模板</h2><p>改一下例子</p>
<p>main.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"></span><br><span class="line">Vue.config.productionTip = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* eslint-disable no-new */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  data: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      arr:[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  template: <span class="string">`&lt;div&gt;</span></span><br><span class="line"><span class="string">    &lt;p v-if="!arr.length" v-for="item in arr"&gt;&#123;&#123;item&#125;&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;`</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>生成的<code>render</code>函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> <span class="title">anonymous</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">with</span>(<span class="keyword">this</span>)&#123;<span class="keyword">return</span> _c(<span class="string">'div'</span>,_l((arr),<span class="function"><span class="keyword">function</span>(<span class="params">item</span>)</span>&#123;<span class="keyword">return</span> (!arr.length)?_c(<span class="string">'p'</span>,[_v(_s(item))]):_e()&#125;),<span class="number">0</span>)&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>优先调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_l((arr),<span class="function"><span class="keyword">function</span>(<span class="params">item</span>)</span>&#123;<span class="keyword">return</span> (!arr.length)?_c(<span class="string">'p'</span>,[_v(_s(item))]):_e()&#125;)</span><br></pre></td></tr></table></figure>
<p><code>_l</code>也就是下面这个方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderList</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  val,</span></span></span><br><span class="line"><span class="function"><span class="params">  render</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> ret, i, l, keys, key;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(val) || <span class="keyword">typeof</span> val === <span class="string">'string'</span>) &#123;</span><br><span class="line">    ret = <span class="keyword">new</span> <span class="built_in">Array</span>(val.length);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>, l = val.length; i &lt; l; i++) &#123;</span><br><span class="line">      ret[i] = render(val[i], i);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> val === <span class="string">'number'</span>) &#123;</span><br><span class="line">    ret = <span class="keyword">new</span> <span class="built_in">Array</span>(val);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; val; i++) &#123;</span><br><span class="line">      ret[i] = render(i + <span class="number">1</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isObject(val)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (hasSymbol &amp;&amp; val[<span class="built_in">Symbol</span>.iterator]) &#123;</span><br><span class="line">      ret = [];</span><br><span class="line">      <span class="keyword">var</span> iterator = val[<span class="built_in">Symbol</span>.iterator]();</span><br><span class="line">      <span class="keyword">var</span> result = iterator.next();</span><br><span class="line">      <span class="keyword">while</span> (!result.done) &#123;</span><br><span class="line">        ret.push(render(result.value, ret.length));</span><br><span class="line">        result = iterator.next();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      keys = <span class="built_in">Object</span>.keys(val);</span><br><span class="line">      ret = <span class="keyword">new</span> <span class="built_in">Array</span>(keys.length);</span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">0</span>, l = keys.length; i &lt; l; i++) &#123;</span><br><span class="line">        key = keys[i];</span><br><span class="line">        ret[i] = render(val[key], key, i);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!isDef(ret)) &#123;</span><br><span class="line">    ret = [];</span><br><span class="line">  &#125;</span><br><span class="line">  (ret)._isVList = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果传入的<code>val</code>是数组，就会遍历数组，调用<code>ret[i] = render(val[i], i);</code>，而这里的遍历操作是无意义的</p>
<h2 id="keep-alive"><a href="#keep-alive" class="headerlink" title="keep-alive"></a>keep-alive</h2><p>main.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> child1 = &#123;</span><br><span class="line">  template: <span class="string">'&lt;div&gt;&lt;button @click="add"&gt;add&lt;/button&gt;&lt;p&gt;&#123;&#123;num&#125;&#125;&lt;/p&gt;&lt;/div&gt;'</span>,</span><br><span class="line">  data () &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      num: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  activated () &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'active'</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  created () &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'created'</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  mounted () &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'mounted'</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    add () &#123;</span><br><span class="line">      <span class="keyword">this</span>.num++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> child2 = &#123;</span><br><span class="line">  template: <span class="string">'&lt;div&gt;child2&lt;/div&gt;'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* eslint-disable no-new */</span></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  components: &#123;</span><br><span class="line">    child1, child2</span><br><span class="line">  &#125;,</span><br><span class="line">  data () &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      chooseTabs: <span class="string">'child1'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    changeTabs (tab) &#123;</span><br><span class="line">      <span class="keyword">this</span>.chooseTabs = tab</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">  &lt;div&gt;</span></span><br><span class="line"><span class="string">    &lt;button @click="changeTabs('child1')"&gt;child1&lt;/button&gt;</span></span><br><span class="line"><span class="string">    &lt;button @click="changeTabs('child2')"&gt;child2&lt;/button&gt;</span></span><br><span class="line"><span class="string">    &lt;keep-alive&gt;</span></span><br><span class="line"><span class="string">        &lt;component :is="chooseTabs"&gt;</span></span><br><span class="line"><span class="string">        &lt;/component&gt;</span></span><br><span class="line"><span class="string">    &lt;/keep-alive&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>首先声明了<code>KeepAlive</code>对象，之后作为<code>builtInComponents</code>对象的元素</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> KeepAlive = &#123;</span><br><span class="line">  name: <span class="string">'keep-alive'</span>,</span><br><span class="line">  abstract: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  props: &#123;</span><br><span class="line">    include: patternTypes,</span><br><span class="line">    exclude: patternTypes,</span><br><span class="line">    max: [<span class="built_in">String</span>, <span class="built_in">Number</span>]</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  created: <span class="function"><span class="keyword">function</span> <span class="title">created</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.cache = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">this</span>.keys = [];</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  destroyed: <span class="function"><span class="keyword">function</span> <span class="title">destroyed</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> <span class="keyword">this</span>.cache) &#123;</span><br><span class="line">      pruneCacheEntry(<span class="keyword">this</span>.cache, key, <span class="keyword">this</span>.keys);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  mounted: <span class="function"><span class="keyword">function</span> <span class="title">mounted</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">this</span>$<span class="number">1</span> = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.$watch(<span class="string">'include'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">val</span>) </span>&#123;</span><br><span class="line">      pruneCache(<span class="keyword">this</span>$<span class="number">1</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123; <span class="keyword">return</span> matches(val, name); &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">this</span>.$watch(<span class="string">'exclude'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">val</span>) </span>&#123;</span><br><span class="line">      pruneCache(<span class="keyword">this</span>$<span class="number">1</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123; <span class="keyword">return</span> !matches(val, name); &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  render: <span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> slot = <span class="keyword">this</span>.$slots.default;</span><br><span class="line">    <span class="keyword">var</span> vnode = getFirstComponentChild(slot);</span><br><span class="line">    <span class="keyword">var</span> componentOptions = vnode &amp;&amp; vnode.componentOptions;</span><br><span class="line">    <span class="keyword">if</span> (componentOptions) &#123;</span><br><span class="line">      <span class="comment">// check pattern</span></span><br><span class="line">      <span class="keyword">var</span> name = getComponentName(componentOptions);</span><br><span class="line">      <span class="keyword">var</span> ref = <span class="keyword">this</span>;</span><br><span class="line">      <span class="keyword">var</span> include = ref.include;</span><br><span class="line">      <span class="keyword">var</span> exclude = ref.exclude;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        <span class="comment">// not included</span></span><br><span class="line">        (include &amp;&amp; (!name || !matches(include, name))) ||</span><br><span class="line">        <span class="comment">// excluded</span></span><br><span class="line">        (exclude &amp;&amp; name &amp;&amp; matches(exclude, name))</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="keyword">return</span> vnode</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">var</span> ref$<span class="number">1</span> = <span class="keyword">this</span>;</span><br><span class="line">      <span class="keyword">var</span> cache = ref$<span class="number">1.</span>cache;</span><br><span class="line">      <span class="keyword">var</span> keys = ref$<span class="number">1.</span>keys;</span><br><span class="line">      <span class="keyword">var</span> key = vnode.key == <span class="literal">null</span></span><br><span class="line">        <span class="comment">// same constructor may get registered as different local components</span></span><br><span class="line">        <span class="comment">// so cid alone is not enough (#3269)</span></span><br><span class="line">        ? componentOptions.Ctor.cid + (componentOptions.tag ? (<span class="string">"::"</span> + (componentOptions.tag)) : <span class="string">''</span>)</span><br><span class="line">        : vnode.key;</span><br><span class="line">      <span class="keyword">if</span> (cache[key]) &#123;</span><br><span class="line">        vnode.componentInstance = cache[key].componentInstance;</span><br><span class="line">        <span class="comment">// make current key freshest</span></span><br><span class="line">        remove(keys, key);</span><br><span class="line">        keys.push(key);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cache[key] = vnode;</span><br><span class="line">        keys.push(key);</span><br><span class="line">        <span class="comment">// prune oldest entry</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.max &amp;&amp; keys.length &gt; <span class="built_in">parseInt</span>(<span class="keyword">this</span>.max)) &#123;</span><br><span class="line">          pruneCacheEntry(cache, keys[<span class="number">0</span>], keys, <span class="keyword">this</span>._vnode);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      vnode.data.keepAlive = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> vnode || (slot &amp;&amp; slot[<span class="number">0</span>])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> builtInComponents = &#123;</span><br><span class="line">  KeepAlive: KeepAlive</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在<code>initGlobalAPI</code>方法调用中<code>extend(Vue.options.components, builtInComponents);</code>，把<code>keepAlive</code>组件添加到<code>Vue.options.components</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initGlobalAPI</span> (<span class="params">Vue</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// config</span></span><br><span class="line">  <span class="keyword">var</span> configDef = &#123;&#125;;</span><br><span class="line">  configDef.get = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="keyword">return</span> config; &#125;;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    configDef.set = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">'Do not replace the Vue.config object, set individual fields instead.'</span></span><br><span class="line">      );</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(Vue, <span class="string">'config'</span>, configDef);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// exposed util methods.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> these are not considered part of the public API - avoid relying on</span></span><br><span class="line">  <span class="comment">// them unless you are aware of the risk.</span></span><br><span class="line">  Vue.util = &#123;</span><br><span class="line">    warn: warn,</span><br><span class="line">    extend: extend,</span><br><span class="line">    mergeOptions: mergeOptions,</span><br><span class="line">    defineReactive: defineReactive$$<span class="number">1</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Vue.set = set;</span><br><span class="line">  Vue.delete = del;</span><br><span class="line">  Vue.nextTick = nextTick;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2.6 explicit observable API</span></span><br><span class="line">  Vue.observable = <span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    observe(obj);</span><br><span class="line">    <span class="keyword">return</span> obj</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Vue.options = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line">  ASSET_TYPES.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">type</span>) </span>&#123;</span><br><span class="line">    Vue.options[type + <span class="string">'s'</span>] = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// this is used to identify the "base" constructor to extend all plain-object</span></span><br><span class="line">  <span class="comment">// components with in Weex's multi-instance scenarios.</span></span><br><span class="line">  Vue.options._base = Vue;</span><br><span class="line"></span><br><span class="line">  extend(Vue.options.components, builtInComponents);</span><br><span class="line"></span><br><span class="line">  initUse(Vue);</span><br><span class="line">  initMixin$<span class="number">1</span>(Vue);</span><br><span class="line">  initExtend(Vue);</span><br><span class="line">  initAssetRegisters(Vue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>首次渲染：</strong></p>
<p>根据<code>ast</code>生成的<code>render</code>函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> <span class="title">anonymous</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">with</span>(<span class="keyword">this</span>)&#123;<span class="keyword">return</span> _c(<span class="string">'div'</span>,[_c(<span class="string">'button'</span>,&#123;<span class="attr">on</span>:&#123;<span class="string">"click"</span>:<span class="function"><span class="keyword">function</span>(<span class="params">$event</span>)</span>&#123;<span class="keyword">return</span> changeTabs(<span class="string">'child1'</span>)&#125;&#125;&#125;,[_v(<span class="string">"child1"</span>)]),_v(<span class="string">" "</span>),_c(<span class="string">'button'</span>,&#123;<span class="attr">on</span>:&#123;<span class="string">"click"</span>:<span class="function"><span class="keyword">function</span>(<span class="params">$event</span>)</span>&#123;<span class="keyword">return</span> changeTabs(<span class="string">'child2'</span>)&#125;&#125;&#125;,[_v(<span class="string">"child2"</span>)]),_v(<span class="string">" "</span>),_c(<span class="string">'keep-alive'</span>,[_c(chooseTabs,&#123;<span class="attr">tag</span>:<span class="string">"component"</span>&#125;)],<span class="number">1</span>)],<span class="number">1</span>)&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>在<code>patch</code>阶段</p>
<p>生成<code>keep-alive</code>组件的<code>vnode</code>的时候，<code>render</code>函数就是<code>keep-alive</code>组件的<code>render</code>函数</p>
<p><img src="http://114.55.30.96/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190927223928.png" alt="微信截图_20190927223928"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">render: <span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> slot = <span class="keyword">this</span>.$slots.default;</span><br><span class="line">  <span class="keyword">var</span> vnode = getFirstComponentChild(slot);</span><br><span class="line">  <span class="keyword">var</span> componentOptions = vnode &amp;&amp; vnode.componentOptions;</span><br><span class="line">  <span class="keyword">if</span> (componentOptions) &#123;</span><br><span class="line">    <span class="comment">// check pattern</span></span><br><span class="line">    <span class="keyword">var</span> name = getComponentName(componentOptions);</span><br><span class="line">    <span class="keyword">var</span> ref = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> include = ref.include;</span><br><span class="line">    <span class="keyword">var</span> exclude = ref.exclude;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      <span class="comment">// not included</span></span><br><span class="line">      (include &amp;&amp; (!name || !matches(include, name))) ||</span><br><span class="line">      <span class="comment">// excluded</span></span><br><span class="line">      (exclude &amp;&amp; name &amp;&amp; matches(exclude, name))</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">return</span> vnode</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> ref$<span class="number">1</span> = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> cache = ref$<span class="number">1.</span>cache;</span><br><span class="line">    <span class="keyword">var</span> keys = ref$<span class="number">1.</span>keys;</span><br><span class="line">    <span class="keyword">var</span> key = vnode.key == <span class="literal">null</span></span><br><span class="line">      <span class="comment">// same constructor may get registered as different local components</span></span><br><span class="line">      <span class="comment">// so cid alone is not enough (#3269)</span></span><br><span class="line">      ? componentOptions.Ctor.cid + (componentOptions.tag ? (<span class="string">"::"</span> + (componentOptions.tag)) : <span class="string">''</span>)</span><br><span class="line">      : vnode.key;</span><br><span class="line">    <span class="keyword">if</span> (cache[key]) &#123;</span><br><span class="line">      vnode.componentInstance = cache[key].componentInstance;</span><br><span class="line">      <span class="comment">// make current key freshest</span></span><br><span class="line">      remove(keys, key);</span><br><span class="line">      keys.push(key);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      cache[key] = vnode;</span><br><span class="line">      keys.push(key);</span><br><span class="line">      <span class="comment">// prune oldest entry</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.max &amp;&amp; keys.length &gt; <span class="built_in">parseInt</span>(<span class="keyword">this</span>.max)) &#123;</span><br><span class="line">        pruneCacheEntry(cache, keys[<span class="number">0</span>], keys, <span class="keyword">this</span>._vnode);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vnode.data.keepAlive = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> vnode || (slot &amp;&amp; slot[<span class="number">0</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里对组件<code>vnode</code>进行了缓存，之后有用到的时候会取出来</p>
<p><strong>缓存渲染：</strong></p>
<p>点击添加按钮，并且切换视图两次，触发派发更新</p>
<p><img src="http://114.55.30.96/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190928191902.png" alt="微信截图_20190928191902"></p>
<p>走进更新视图的<code>patch</code>，会走进<code>prepatch</code>方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">prepatch: <span class="function"><span class="keyword">function</span> <span class="title">prepatch</span> (<span class="params">oldVnode, vnode</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> options = vnode.componentOptions;</span><br><span class="line">  <span class="keyword">var</span> child = vnode.componentInstance = oldVnode.componentInstance;</span><br><span class="line">  updateChildComponent(</span><br><span class="line">    child,</span><br><span class="line">    options.propsData, <span class="comment">// updated props</span></span><br><span class="line">    options.listeners, <span class="comment">// updated listeners</span></span><br><span class="line">    vnode, <span class="comment">// new parent vnode</span></span><br><span class="line">    options.children <span class="comment">// new children</span></span><br><span class="line">  );</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>然后走进<code>updateChildComponent</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateChildComponent</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  vm,</span></span></span><br><span class="line"><span class="function"><span class="params">  propsData,</span></span></span><br><span class="line"><span class="function"><span class="params">  listeners,</span></span></span><br><span class="line"><span class="function"><span class="params">  parentVnode,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderChildren</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    isUpdatingChildComponent = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// determine whether component has slot children</span></span><br><span class="line">  <span class="comment">// we need to do this before overwriting $options._renderChildren.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// check if there are dynamic scopedSlots (hand-written or compiled but with</span></span><br><span class="line">  <span class="comment">// dynamic slot names). Static scoped slots compiled from template has the</span></span><br><span class="line">  <span class="comment">// "$stable" marker.</span></span><br><span class="line">  <span class="keyword">var</span> newScopedSlots = parentVnode.data.scopedSlots;</span><br><span class="line">  <span class="keyword">var</span> oldScopedSlots = vm.$scopedSlots;</span><br><span class="line">  <span class="keyword">var</span> hasDynamicScopedSlot = !!(</span><br><span class="line">    (newScopedSlots &amp;&amp; !newScopedSlots.$stable) ||</span><br><span class="line">    (oldScopedSlots !== emptyObject &amp;&amp; !oldScopedSlots.$stable) ||</span><br><span class="line">    (newScopedSlots &amp;&amp; vm.$scopedSlots.$key !== newScopedSlots.$key)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Any static slot children from the parent may have changed during parent's</span></span><br><span class="line">  <span class="comment">// update. Dynamic scoped slots may also have changed. In such cases, a forced</span></span><br><span class="line">  <span class="comment">// update is necessary to ensure correctness.</span></span><br><span class="line">  <span class="keyword">var</span> needsForceUpdate = !!(</span><br><span class="line">    renderChildren ||               <span class="comment">// has new static slots</span></span><br><span class="line">    vm.$options._renderChildren ||  <span class="comment">// has old static slots</span></span><br><span class="line">    hasDynamicScopedSlot</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  vm.$options._parentVnode = parentVnode;</span><br><span class="line">  vm.$vnode = parentVnode; <span class="comment">// update vm's placeholder node without re-render</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (vm._vnode) &#123; <span class="comment">// update child tree's parent</span></span><br><span class="line">    vm._vnode.parent = parentVnode;</span><br><span class="line">  &#125;</span><br><span class="line">  vm.$options._renderChildren = renderChildren;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// update $attrs and $listeners hash</span></span><br><span class="line">  <span class="comment">// these are also reactive so they may trigger child update if the child</span></span><br><span class="line">  <span class="comment">// used them during render</span></span><br><span class="line">  vm.$attrs = parentVnode.data.attrs || emptyObject;</span><br><span class="line">  vm.$listeners = listeners || emptyObject;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// update props</span></span><br><span class="line">  <span class="keyword">if</span> (propsData &amp;&amp; vm.$options.props) &#123;</span><br><span class="line">    toggleObserving(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">var</span> props = vm._props;</span><br><span class="line">    <span class="keyword">var</span> propKeys = vm.$options._propKeys || [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; propKeys.length; i++) &#123;</span><br><span class="line">      <span class="keyword">var</span> key = propKeys[i];</span><br><span class="line">      <span class="keyword">var</span> propOptions = vm.$options.props; <span class="comment">// wtf flow?</span></span><br><span class="line">      props[key] = validateProp(key, propOptions, propsData, vm);</span><br><span class="line">    &#125;</span><br><span class="line">    toggleObserving(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// keep a copy of raw propsData</span></span><br><span class="line">    vm.$options.propsData = propsData;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// update listeners</span></span><br><span class="line">  listeners = listeners || emptyObject;</span><br><span class="line">  <span class="keyword">var</span> oldListeners = vm.$options._parentListeners;</span><br><span class="line">  vm.$options._parentListeners = listeners;</span><br><span class="line">  updateComponentListeners(vm, listeners, oldListeners);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// resolve slots + force update if has children</span></span><br><span class="line">  <span class="keyword">if</span> (needsForceUpdate) &#123;</span><br><span class="line">    vm.$slots = resolveSlots(renderChildren, parentVnode.context);</span><br><span class="line">    vm.$forceUpdate();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>调用<code>vm.$forceUpdate</code>，为<code>queue</code>新增了一个<code>wathcer</code></p>
<p><img src="http://114.55.30.96/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190928101915.png" alt="微信截图_20190928101915"></p>
<p>之后调用新增这个<code>wathcer</code>的<code>run</code>方法(最后就是<code>vm._update(vm._render(), hydrating);</code>)，在生成<code>vnode</code>的时候，从<code>cache</code>中取出缓存的<code>vnode</code></p>
<p><img src="http://114.55.30.96/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190928185150.png" alt="微信截图_20190928185150"></p>
<p>之后调用<code>update</code>更新视图，这次走的不是新增的流程，而是比较的</p>
<p>这次在创建子组件的时候</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createComponent</span> (<span class="params">vnode, insertedVnodeQueue, parentElm, refElm</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> i = vnode.data;</span><br><span class="line">  <span class="keyword">if</span> (isDef(i)) &#123;</span><br><span class="line">    <span class="keyword">var</span> isReactivated = isDef(vnode.componentInstance) &amp;&amp; i.keepAlive;</span><br><span class="line">    <span class="keyword">if</span> (isDef(i = i.hook) &amp;&amp; isDef(i = i.init)) &#123;</span><br><span class="line">      i(vnode, <span class="literal">false</span> <span class="comment">/* hydrating */</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// after calling the init hook, if the vnode is a child component</span></span><br><span class="line">    <span class="comment">// it should've created a child instance and mounted it. the child</span></span><br><span class="line">    <span class="comment">// component also has set the placeholder vnode's elm.</span></span><br><span class="line">    <span class="comment">// in that case we can just return the element and be done.</span></span><br><span class="line">    <span class="keyword">if</span> (isDef(vnode.componentInstance)) &#123;</span><br><span class="line">      initComponent(vnode, insertedVnodeQueue);</span><br><span class="line">      insert(parentElm, vnode.elm, refElm);</span><br><span class="line">      <span class="keyword">if</span> (isTrue(isReactivated)) &#123;</span><br><span class="line">        reactivateComponent(vnode, insertedVnodeQueue, parentElm, refElm);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入组建<code>init</code>方法的时候，逻辑是走的这里</p>
<p>进入<code>prepatch</code>方法,在<code>updateChildComponent</code>做了一些更新操作</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">prepatch: <span class="function"><span class="keyword">function</span> <span class="title">prepatch</span> (<span class="params">oldVnode, vnode</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> options = vnode.componentOptions;</span><br><span class="line">  <span class="keyword">var</span> child = vnode.componentInstance = oldVnode.componentInstance;</span><br><span class="line">  updateChildComponent(</span><br><span class="line">    child,</span><br><span class="line">    options.propsData, <span class="comment">// updated props</span></span><br><span class="line">    options.listeners, <span class="comment">// updated listeners</span></span><br><span class="line">    vnode, <span class="comment">// new parent vnode</span></span><br><span class="line">    options.children <span class="comment">// new children</span></span><br><span class="line">  );</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>回到<code>createComponent</code>，在<code>initComponent</code>方法里，把组建实例的<code>$el</code>赋值给了<code>vnode.elm</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vnode.elm = vnode.componentInstance.$el;</span><br></pre></td></tr></table></figure>
<p>之后调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert(parentElm, vnode.elm, refElm);</span><br></pre></td></tr></table></figure>
<p>把缓存的<code>dom</code>结构插入到了插槽中</p>
<p><img src="http://114.55.30.96/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190928192812.png" alt="微信截图_20190928192812"></p>
<p>之后再移除旧的节点</p>
<p><img src="http://114.55.30.96/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190928193001.png" alt="微信截图_20190928193001"></p>
<p>看一下<code>componentInstance</code>在什么时候添加的</p>
<p><img src="http://114.55.30.96/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190929010011.png" alt="微信截图_20190929010011"></p>
<p>看一下<code>createComponentInstanceForVnode</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createComponentInstanceForVnode</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  vnode, <span class="regexp">//</span> we know it<span class="string">'s MountedComponentVNode but flow doesn'</span>t</span></span></span><br><span class="line"><span class="function"><span class="params">  parent <span class="regexp">//</span> activeInstance in lifecycle state</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> options = &#123;</span><br><span class="line">    _isComponent: <span class="literal">true</span>,</span><br><span class="line">    _parentVnode: vnode,</span><br><span class="line">    parent: parent</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// check inline-template render functions</span></span><br><span class="line">  <span class="keyword">var</span> inlineTemplate = vnode.data.inlineTemplate;</span><br><span class="line">  <span class="keyword">if</span> (isDef(inlineTemplate)) &#123;</span><br><span class="line">    options.render = inlineTemplate.render;</span><br><span class="line">    options.staticRenderFns = inlineTemplate.staticRenderFns;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> vnode.componentOptions.Ctor(options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要注意的就是组建在<strong>重新渲染</strong>的时候不会调用<code>created</code>和<code>mounted</code>钩子函数，会调用<code>activated</code>钩子函数</p>
<p>而<strong>首次渲染</strong>也会调用<code>activated</code>钩子函数</p>
<h2 id="Vue-directive"><a href="#Vue-directive" class="headerlink" title="Vue.directive"></a>Vue.directive</h2><p>改一下例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"></span><br><span class="line">Vue.directive(<span class="string">'qhw'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">el, binding, vnode</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(el, binding, vnode)</span><br><span class="line">  el.style = <span class="string">'color:'</span> + binding.value</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">/* eslint-disable no-new */</span></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  data: &#123;</span><br><span class="line">    color: <span class="string">'red'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">  &lt;div v-qhw="color"&gt;</span></span><br><span class="line"><span class="string">    123</span></span><br><span class="line"><span class="string">  &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="http://114.55.30.96/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190929235816.png" alt="微信截图_20190929235816"></p>
<p>看一下<code>updateDirectives</code>方法，其实就是遍历<code>directives</code>，调用<code>_update</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateDirectives</span> (<span class="params">oldVnode, vnode</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (oldVnode.data.directives || vnode.data.directives) &#123;</span><br><span class="line">    _update(oldVnode, vnode);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看一下<code>_update</code>方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_update</span> (<span class="params">oldVnode, vnode</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> isCreate = oldVnode === emptyNode;</span><br><span class="line">  <span class="keyword">var</span> isDestroy = vnode === emptyNode;</span><br><span class="line">  <span class="keyword">var</span> oldDirs = normalizeDirectives$<span class="number">1</span>(oldVnode.data.directives, oldVnode.context);</span><br><span class="line">  <span class="keyword">var</span> newDirs = normalizeDirectives$<span class="number">1</span>(vnode.data.directives, vnode.context);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> dirsWithInsert = [];</span><br><span class="line">  <span class="keyword">var</span> dirsWithPostpatch = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> key, oldDir, dir;</span><br><span class="line">  <span class="keyword">for</span> (key <span class="keyword">in</span> newDirs) &#123;</span><br><span class="line">    oldDir = oldDirs[key];</span><br><span class="line">    dir = newDirs[key];</span><br><span class="line">    <span class="keyword">if</span> (!oldDir) &#123;</span><br><span class="line">      <span class="comment">// new directive, bind</span></span><br><span class="line">      callHook$<span class="number">1</span>(dir, <span class="string">'bind'</span>, vnode, oldVnode);</span><br><span class="line">      <span class="keyword">if</span> (dir.def &amp;&amp; dir.def.inserted) &#123;</span><br><span class="line">        dirsWithInsert.push(dir);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// existing directive, update</span></span><br><span class="line">      dir.oldValue = oldDir.value;</span><br><span class="line">      dir.oldArg = oldDir.arg;</span><br><span class="line">      callHook$<span class="number">1</span>(dir, <span class="string">'update'</span>, vnode, oldVnode);</span><br><span class="line">      <span class="keyword">if</span> (dir.def &amp;&amp; dir.def.componentUpdated) &#123;</span><br><span class="line">        dirsWithPostpatch.push(dir);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dirsWithInsert.length) &#123;</span><br><span class="line">    <span class="keyword">var</span> callInsert = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; dirsWithInsert.length; i++) &#123;</span><br><span class="line">        callHook$<span class="number">1</span>(dirsWithInsert[i], <span class="string">'inserted'</span>, vnode, oldVnode);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (isCreate) &#123;</span><br><span class="line">      mergeVNodeHook(vnode, <span class="string">'insert'</span>, callInsert);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      callInsert();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dirsWithPostpatch.length) &#123;</span><br><span class="line">    mergeVNodeHook(vnode, <span class="string">'postpatch'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; dirsWithPostpatch.length; i++) &#123;</span><br><span class="line">        callHook$<span class="number">1</span>(dirsWithPostpatch[i], <span class="string">'componentUpdated'</span>, vnode, oldVnode);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!isCreate) &#123;</span><br><span class="line">    <span class="keyword">for</span> (key <span class="keyword">in</span> oldDirs) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!newDirs[key]) &#123;</span><br><span class="line">        <span class="comment">// no longer present, unbind</span></span><br><span class="line">        callHook$<span class="number">1</span>(oldDirs[key], <span class="string">'unbind'</span>, oldVnode, oldVnode, isDestroy);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里调用<code>bind</code>钩子，其实就是调用<code>directive</code>传入的函数</p>
<p><img src="http://114.55.30.96/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190930000934.png" alt="微信截图_20190930000934"></p>
<h2 id="ref在什么时候添加到-refs上的"><a href="#ref在什么时候添加到-refs上的" class="headerlink" title="ref在什么时候添加到$refs上的"></a>ref在什么时候添加到$refs上的</h2><p>在<code>patch</code>阶段</p>
<p><img src="http://114.55.30.96/WX20191007-130322@2x.png" alt="WX20191007-130322@2x"></p>
<p><img src="http://114.55.30.96/WX20191007-130349@2x.png" alt="WX20191007-130349@2x"></p>
<p><img src="http://114.55.30.96/WX20191007-130403@2x.png" alt="WX20191007-130403@2x"></p>
<p><img src="http://114.55.30.96/WX20191007-130428@2x.png" alt="WX20191007-130428@2x"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">create: <span class="function"><span class="keyword">function</span> <span class="title">create</span> (<span class="params">_, vnode</span>) </span>&#123;</span><br><span class="line">  registerRef(vnode);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>进入<code>registerRef</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">registerRef</span> (<span class="params">vnode, isRemoval</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> key = vnode.data.ref;</span><br><span class="line">  <span class="keyword">if</span> (!isDef(key)) &#123; <span class="keyword">return</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> vm = vnode.context;</span><br><span class="line">  <span class="keyword">var</span> ref = vnode.componentInstance || vnode.elm;</span><br><span class="line">  <span class="keyword">var</span> refs = vm.$refs;</span><br><span class="line">  <span class="keyword">if</span> (isRemoval) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(refs[key])) &#123;</span><br><span class="line">      remove(refs[key], ref);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (refs[key] === ref) &#123;</span><br><span class="line">      refs[key] = <span class="literal">undefined</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (vnode.data.refInFor) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(refs[key])) &#123;</span><br><span class="line">        refs[key] = [ref];</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (refs[key].indexOf(ref) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// $flow-disable-line</span></span><br><span class="line">        refs[key].push(ref);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      refs[key] = ref;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法获取了<code>vm.$refs</code>，并且传值给<code>refs</code>，之后为<code>refs</code>添加属性</p>
<h2 id="组件style标签中scoped的作用"><a href="#组件style标签中scoped的作用" class="headerlink" title="组件style标签中scoped的作用"></a>组件style标签中scoped的作用</h2><p>在创建占位符的时候，调用setScope的时候，为标签设置了一个属性</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setScope</span> (<span class="params">vnode</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> i;</span><br><span class="line">  <span class="keyword">if</span> (isDef(i = vnode.fnScopeId)) &#123;</span><br><span class="line">    nodeOps.setStyleScope(vnode.elm, i);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> ancestor = vnode;</span><br><span class="line">    <span class="keyword">while</span> (ancestor) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isDef(i = ancestor.context) &amp;&amp; isDef(i = i.$options._scopeId)) &#123;</span><br><span class="line">        nodeOps.setStyleScope(vnode.elm, i);</span><br><span class="line">      &#125;</span><br><span class="line">      ancestor = ancestor.parent;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// for slot content they should also get the scopeId from the host instance.</span></span><br><span class="line">  <span class="keyword">if</span> (isDef(i = activeInstance) &amp;&amp;</span><br><span class="line">    i !== vnode.context &amp;&amp;</span><br><span class="line">    i !== vnode.fnContext &amp;&amp;</span><br><span class="line">    isDef(i = i.$options._scopeId)</span><br><span class="line">  ) &#123;</span><br><span class="line">    nodeOps.setStyleScope(vnode.elm, i);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://114.55.30.96/WX20191024-000600@2x.png" alt="WX20191024-000600@2x"></p>
<p><img src="http://114.55.30.96/WX20191024-000626@2x.png" alt="WX20191024-000626@2x"></p>
<p><img src="http://114.55.30.96/WX20191024-000744@2x.png" alt="WX20191024-000744@2x"></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Vue源码过程/" rel="tag"># Vue源码过程</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/09/08/Vue源码解析（6）-路由/" rel="next" title="Vue源码过程（6）- 路由">
                <i class="fa fa-chevron-left"></i> Vue源码过程（6）- 路由
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/10/01/react源码过程（1）-准备工作/" rel="prev" title="react源码过程（1）- 准备工作">
                react源码过程（1）- 准备工作 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="秦瀚文" />
          <p class="site-author-name" itemprop="name">秦瀚文</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/index.html">
                <span class="site-state-item-count">155</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">41</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">41</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#补充"><span class="nav-number">1.</span> <span class="nav-text">补充</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#事件"><span class="nav-number">1.1.</span> <span class="nav-text">事件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#双向绑定原理"><span class="nav-number">1.2.</span> <span class="nav-text">双向绑定原理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数组"><span class="nav-number">2.</span> <span class="nav-text">数组</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nextTick"><span class="nav-number">3.</span> <span class="nav-text">nextTick</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vue-组件中-data-为什么必须是函数"><span class="nav-number">4.</span> <span class="nav-text">Vue 组件中 data 为什么必须是函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义事件通知"><span class="nav-number">5.</span> <span class="nav-text">自定义事件通知</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#vue中-key-值的作用"><span class="nav-number">6.</span> <span class="nav-text">vue中 key 值的作用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么key不建议使用index"><span class="nav-number">7.</span> <span class="nav-text">为什么key不建议使用index</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#v-show和v-if指令的共同点和不同点"><span class="nav-number">8.</span> <span class="nav-text">v-show和v-if指令的共同点和不同点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#route与-router"><span class="nav-number">9.</span> <span class="nav-text">\$route与\$router</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#插槽"><span class="nav-number">10.</span> <span class="nav-text">插槽</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#计算属性与监听属性"><span class="nav-number">11.</span> <span class="nav-text">计算属性与监听属性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#v-if与v-for不建议使用在同一个模板"><span class="nav-number">12.</span> <span class="nav-text">v-if与v-for不建议使用在同一个模板</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#keep-alive"><span class="nav-number">13.</span> <span class="nav-text">keep-alive</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vue-directive"><span class="nav-number">14.</span> <span class="nav-text">Vue.directive</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ref在什么时候添加到-refs上的"><span class="nav-number">15.</span> <span class="nav-text">ref在什么时候添加到$refs上的</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#组件style标签中scoped的作用"><span class="nav-number">16.</span> <span class="nav-text">组件style标签中scoped的作用</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">秦瀚文</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
